var Writer=function(e){var e=e||{},a={layout:null,editor:null,entities:{},structs:{},triples:[],deletedEntities:{},deletedStructs:{},schemaXML:null,schema:{elements:[]},project:e.project,baseUrl:window.location.protocol+"//"+window.location.host+"/",mode:e.mode,validationSchema:"cwrcbasic",root:"",header:"",idName:"",XMLRDF:0,XML:1,NO_SELECTION:0,NO_COMMON_PARENT:1,VALID:2,fixEmptyTag:!1,emptyTagId:null,u:null,fm:null,entitiesList:null,tree:null,relations:null,d:null,settings:null},b=function(g){g.dom.isBlock=
function(a){var b=a.nodeType;b&&1===b&&(a=a.getAttribute("_tag")||a.nodeName);return!!g.schema.getBlockElements()[a]};var b=a.settings.getSettings();b.showEntityBrackets&&g.$("body").addClass("showEntityBrackets");b.showStructBrackets&&g.$("body").addClass("showStructBrackets");g.addCommand("isSelectionValid",a.u.isSelectionValid);g.addCommand("showError",a.showError);g.addCommand("addEntity",a.addEntity);g.addCommand("editTag",a.editTag);g.addCommand("changeTag",a.changeTag);g.addCommand("removeTag",
a.removeTag);g.addCommand("copyEntity",a.copyEntity);g.addCommand("pasteEntity",a.pasteEntity);g.addCommand("removeEntity",a.removeEntity);g.addCommand("addStructureTag",a.addStructureTag);g.addCommand("editStructureTag",a.editStructureTag);g.addCommand("changeStructureTag",a.changeStructureTag);g.addCommand("updateStructureTree",a.tree.update);g.addCommand("removeHighlights",a.removeHighlights);g.addCommand("exportDocument",a.fm.exportDocument);g.addCommand("loadDocument",a.fm.loadDocument);g.addCommand("getChildrenForTag",
a.u.getChildrenForTag);g.addCommand("getParentsForTag",a.u.getParentsForTag);g.addCommand("getDocumentationForTag",a.getDocumentationForTag);g.pasteAsPlainText=!1;g.onMouseUp.add(function(a,g){c(g);n(a,g)});g.onKeyDown.add(j);g.onKeyUp.add(f);setTimeout(function(){a.layout.resizeAll()},250);a.fm.loadInitialDocument(window.location.hash)},h=function(){for(var g in a.entities){var b=a.editor.dom.select('span[name="'+g+'"]');switch(b.length){case 0:a.entitiesList.remove(g);a.deletedEntities[g]=a.entities[g];
delete a.entities[g];break;case 1:a.editor.dom.remove(b[0]),a.entitiesList.remove(g),a.deletedEntities[g]=a.entities[g],delete a.entities[g]}}for(g in a.structs)b=a.editor.dom.select("#"+g),0==b.length&&(a.deletedStructs[g]=a.structs[g],delete a.structs[g])},j=function(g,b){if((89==b.which||90==b.which)&&b.ctrlKey)h(),a.entitiesList.update(),a.tree.update()},f=function(g,b){(33<=b.which||40>=b.which)&&n(g,b);if(g.currentEntity){var d=g.$("#entityHighlight").text(),p=a.entities[g.currentEntity];p.content=
d;p.title=a.u.getTitleFromContent(d);$('#entities li[name="'+g.currentEntity+'"] > span[class="entityTitle"]').html(p.title)}a.fixEmptyTag&&(a.fixEmptyTag=!1,g.$('[class="empty_tag_remove_me"]').remove());a.emptyTagId&&(48<=b.which||90>=b.which?(d=g.selection.getRng(!0),d.setStart(d.commonAncestorContainer,d.startOffset-1),d.setEnd(d.commonAncestorContainer,d.startOffset+1),a.insertBoundaryTags(a.emptyTagId,a.entities[a.emptyTagId].props.type,d),p=g.$("[name="+a.emptyTagId+"]"),d=g.selection.getRng(!0),
d.setStartAfter(p[0]),d.setEndBefore(p[1]),d.collapse(!1),a.entitiesList.update()):delete a.entities[a.emptyTagId],a.emptyTagId=null);g.currentNode&&("false"==g.currentNode.getAttribute("_textallowed")&&(a.d.show("message",{title:"No Text Allowed",msg:"Text is not allowed in the current tag: "+g.currentNode.getAttribute("_tag")+".",type:"error"}),$(g.currentNode).contents().filter(function(){return 3==this.nodeType}).remove()),b.shiftKey&&13==b.which&&(d=g.currentNode,"lb"==g.$(d).attr("_tag")&&(d=
d.parentNode),g.$(d).find("br").replaceWith('<span _tag="lb"></span>')));if(8==b.which||46==b.which)h(),a.tree.update()},i=function(g){g.isDirty()&&(g.$("br").remove(),h(),a.tree.update())},d=function(g,b,c){1!=c.nodeType?(b=g.$(a.root,g.getBody()),g.currentNode=b[0]):null==c.getAttribute("_tag")&&c.nodeName!=a.root?(c=c.parentNode,d(g,b,c)):g.currentNode=c;g.currentNode&&a.tree.selectNode(g.currentNode.id);a.emptyTagId&&(delete a.entities[a.emptyTagId],a.emptyTagId=null)},k=function(){window.setTimeout(function(){for(b in a.entities){var g=
a.editor.$('span[class~="start"][name="'+b+'"]');1<g.length&&g.each(function(g,d){if(0<g){var p=tinymce.DOM.uniqueId("ent_"),c=$(d),f=$(a.getCorrespondingEntityTag(c));c.attr("name",p);f.attr("name",p);c=jQuery.extend(!0,{},a.entities[b]);c.props.id=p;a.entities[p]=c}})}for(var b in a.structs)if(g=a.editor.$("*[id="+b+"]"),2==g.length){var g=g.last(),d=tinymce.DOM.uniqueId("struct_");g.attr("id",d);a.structs[d]={};for(var p in a.structs[b])a.structs[d][p]=a.structs[b][p];a.structs[d].id=d}a.entitiesList.update();
a.tree.update()},0)},c=function(g){var b=$(g.target);$.vakata.context.vis&&0==b.parents("#vakata-contextmenu").length&&$.vakata.context.hide();0<$("#menu_editor_contextmenu:visible").length&&0==b.parents("#menu_editor_contextmenu").length&&a.editor.execCommand("hideContextMenu",a.editor,g)},n=function(g){var b=g.selection.getRng(!0),d=m("start",b.startContainer);null==m("end",b.endContainer)||null==d?(a.highlightEntity(),g=g.$(g.selection.getNode()),g.attr("_tag")&&(b=g.attr("id"),a.editor.currentStruct=
b)):(b=d.getAttribute("name"),b!=g.currentEntity&&a.highlightEntity(b,g.selection.getBookmark()))};a.getCorrespondingEntityTag=function(a){a=$(a);return a.hasClass("start")?m("end",a[0].nextSibling):m("start",a[0].previousSibling)};var m=function(g,b){function d(b,g,c,r,f){if(g.id){if(f[g.id])return null;f[g.id]=!0}if(a.editor.dom.hasClass(g,"entity")){var i=g.getAttribute("name");if(a.editor.dom.hasClass(g,b)){if(-1==c.indexOf(i))return g;c[0]==i&&c.shift()}else c.push(i)}if("start"==b&&g.lastChild)return r.push(g),
d(b,g.lastChild,c,r,f);if("end"==b&&g.firstChild)return r.push(g),d(b,g.firstChild,c,r,f);if("start"==b&&g.previousSibling)return d(b,g.previousSibling,c,r,f);if("end"==b&&g.nextSibling)return d(b,g.nextSibling,c,r,f);if(g.parentNode)if(g.parentNode==r[r.length-1]){r.pop();if("start"==b&&g.parentNode.previousSibling)return d(b,g.parentNode.previousSibling,c,r,f);if("end"==b&&g.parentNode.nextSibling)return d(b,g.parentNode.nextSibling,c,r,f)}else return d(b,g.parentNode,c,r,f);return null}return d(g,
b,[],[b.parentNode],{})};a.highlightEntity=function(g,b,d){a.editor.currentEntity=null;var c=a.editor.$("#entityHighlight");if(1==c.length){var f=c.parent()[0];c.contents().unwrap();f.normalize();$("#entities > ul > li").each(function(){$(this).removeClass("selected").css("background-color","").find('div[class="info"]').hide()})}if(g){a.editor.currentEntity=g;for(var c=a.entities[g].props.type,i=a.editor.dom.select('span[name="'+g+'"]'),f=i[0],i=i[1],n=[f],k=f;k!=i&&null!=k;)k=k.nextSibling,n.push(k);
a.editor.$(n).wrapAll('<span id="entityHighlight" class="'+c+'"/>');b&&a.editor.selection.moveToBookmark(b);d&&(b=a.editor.$(f).offset().top,a.editor.$(a.editor.dom.doc.body).scrollTop(b));$('#entities > ul > li[name="'+g+'"]').addClass("selected").find('div[class="info"]').show()}};a.showError=function(g){switch(g){case a.NO_SELECTION:a.d.show("message",{title:"Error",msg:"Please select some text before adding an entity or tag.",type:"error"});break;case a.NO_COMMON_PARENT:a.d.show("message",{title:"Error",
msg:"Please ensure that the beginning and end of your selection have a common parent.<br/>For example, your selection cannot begin in one paragraph and end in another, or begin in bolded text and end outside of that text.",type:"error"})}};a.addEntity=function(g){var b=a.u.isSelectionValid();b==a.VALID?(a.editor.currentBookmark=a.editor.selection.getBookmark(1),a.d.show(g,{type:g,title:a.em.getTitle(g),pos:a.editor.contextMenuPos})):a.showError(b)};a.insertBoundaryTags=function(g,b,d){var c=a.editor.selection,
f=c.getBookmark(),i=a.editor.dom.create("span",{_entity:!0,_type:b,"class":"entity "+b+" start",name:g});d.insertNode(i);a.editor.dom.bind(i,"click",l);a.editor.selection.moveToBookmark(f);g=a.editor.dom.create("span",{_entity:!0,_type:b,"class":"entity "+b+" end",name:g});c.collapse(!1);d=c.getRng(!0);d.insertNode(g);a.editor.dom.bind(g,"click",l)};a.finalizeEntity=function(b,d){a.editor.selection.moveToBookmark(a.editor.currentBookmark);if(null!=d){var c=a.editor.selection,p=c.getContent(),f=c.getRng(!0),
p=p.replace(/<\/?[^>]+>/gi,"");if(f.startContainer==f.endContainer){var i=p.match(/^\s{0,1}/)[0].length,k=p.match(/\s{0,1}$/)[0].length;f.setStart(f.startContainer,f.startOffset+i);f.setEnd(f.endContainer,f.endOffset-k);c.setRng(f);p=p.replace(/^\s+|\s+$/g,"")}c=a.u.getTitleFromContent(p);i=tinymce.DOM.uniqueId("ent_");a.editor.currentEntity=i;a.entities[i]={props:{id:i,type:b,title:c,content:p},info:{}};""!=p?a.insertBoundaryTags(i,b,f):a.emptyTagId=i;a.entities[i].info=d;a.entitiesList.update();
a.highlightEntity(i)}a.editor.currentBookmark=null;a.editor.focus()};var q=function(b){var d={entity:null,struct:null};null!=b?a.entities[b]?d.entity=a.entities[b]:a.structs[b]&&(d.struct=a.editor.$("#"+b)):null!=a.editor.currentEntity?d.entity=a.entities[a.editor.currentEntity]:null!=a.editor.currentStruct&&(d.struct=a.editor.$("#"+a.editor.currentStruct));return d};a.editTag=function(b,d){var c=q(b);if(c.struct)a.editor.$(c.struct).attr("_tag")?a.editor.execCommand("editSchemaTag",c.struct,d):a.editor.execCommand("editCustomTag",
c.struct,d);else if(c.entity){var f=c.entity.props.type;a.d.show(f,{type:f,title:a.em.getTitle(f),pos:d,entry:c.entity})}};a.changeTag=function(b){var d=q(b.id);d.struct&&a.editor.$(d.struct).attr("_tag")&&a.editor.execCommand("changeSchemaTag",{tag:d.struct,pos:b.pos,key:b.key})};a.editEntity=function(b,d){a.entities[b].info=d;a.entitiesList.update();a.highlightEntity(b)};a.copyEntity=function(b){b=q(b);b.entity?a.editor.entityCopy=b.entity:a.d.show("message",{title:"Error",msg:"Cannot copy structural tags.",
type:"error"})};a.pasteEntity=function(){if(null==a.editor.entityCopy)a.d.show("message",{title:"Error",msg:"No entity to copy!",type:"error"});else{var b=jQuery.extend(!0,{},a.editor.entityCopy);b.props.id=tinymce.DOM.uniqueId("ent_");a.editor.selection.moveToBookmark(a.editor.currentBookmark);var d=a.editor.selection;d.collapse();var d=d.getRng(!0),c=a.editor.dom.create("span",{"class":"entity "+b.props.type+" start",name:b.props.id,_entity:!0}),f=a.editor.getDoc().createTextNode(b.props.content),
i=a.editor.dom.create("span",{"class":"entity "+b.props.type+" end",name:b.props.id,_entity:!0}),k=a.editor.dom.create("span",{id:"entityHighlight"});a.editor.dom.add(k,c);a.editor.dom.add(k,f);a.editor.dom.add(k,i);d.insertNode(k);a.editor.dom.bind(c,"click",l);a.editor.dom.bind(i,"click",l);a.entities[b.props.id]=b;a.entitiesList.update();a.highlightEntity(b.props.id)}};a.removeTag=function(b){null!=b?a.entities[b]?a.removeEntity(b):a.structs[b]&&a.removeStructureTag(b):null!=a.editor.currentEntity?
a.removeEntity(a.editor.currentEntity):null!=a.editor.currentStruct&&a.removeStructureTag(a.editor.currentStruct)};a.removeEntity=function(b){b=b||a.editor.currentEntity;delete a.entities[b];var d=a.editor.$('span[name="'+b+'"]'),c=d[0].parentNode;d.remove();c.normalize();a.highlightEntity();a.entitiesList.remove(b);a.editor.currentEntity=null};var l=function(b){var b=a.editor.dom.get(b.target),d=a.editor.selection.getRng(!0);a.editor.dom.hasClass(b,"start")?(d.setStartAfter(b),d.setEndAfter(b)):
(d.setStartBefore(b),d.setEndBefore(b));a.editor.selection.setRng(d);a.highlightEntity(b.getAttribute("name"),a.editor.selection.getBookmark())};a.addStructureTag=function(b){var d=b.bookmark,c=b.attributes,b=b.action,f=tinymce.DOM.uniqueId("struct_");c.id=f;c._textallowed=a.u.canTagContainText(c._tag);a.structs[f]=c;a.editor.currentStruct=f;for(f=d.rng.commonAncestorContainer;3==f.nodeType;)f=f.parentNode;var i="<span",k;for(k in c)if("id"==k||null!=k.match(/^_/))i+=" "+k+'="'+c[k]+'"';i+=">";c=
'<span class="empty_tag_remove_me"></span>';k=i+c+"</span>";"before"==b?$(f).before(k):"after"==b?$(f).after(k):"around"==b?$(f).wrap(k):"inside"==b?$(f).wrapInner(k):(a.editor.selection.moveToBookmark(d),c=a.editor.selection.getContent(),""==c&&(c='<span class="empty_tag_remove_me"></span>'),a.editor.execCommand("mceReplaceContent",!1,i+c+"</span>"));'<span class="empty_tag_remove_me"></span>'==c&&(a.fixEmptyTag=!0,d=a.editor.$('span[class="empty_tag_remove_me"]').parent()[0],b=a.editor.selection.getRng(!0),
b.setStart(d.firstChild,0),b.setEnd(d.lastChild,d.lastChild.length),a.editor.getDoc().getSelection().addRange(b));a.tree.update()};a.editStructureTag=function(b,d){var c=b.attr("id");d.id=c;$.each($(b[0].attributes),function(a,d){"id"!=d.name&&b.removeAttr(d.name)});for(var f in d)null!=f.match(/^_/)&&b.attr(f,d[f]);a.structs[c]=d;a.tree.update()};a.removeStructureTag=function(b,d){b=b||a.editor.currentStruct;delete a.structs[b];var c=a.editor.$("#"+b);if(d)c.remove();else{var f=c.parent()[0],i=c.contents();
0<i.length?i.unwrap():c.remove();f.normalize()}a.tree.update();a.editor.currentStruct=null};a.selectStructureTag=function(b){a.editor.currentStruct=b;b=a.editor.$("#"+b);a.fixEmptyTag=!0;b.append('<span class="empty_tag_remove_me"></span>');b=b[0];a.editor.selection.select(b);a.editor.parents=[];a.editor.dom.getParent(b,function(b){if("BODY"==b.nodeName)return!0;a.editor.parents.push(b)});a.editor.onNodeChange.dispatch(a.editor,a.editor.controlManager,b,!1,a.editor);a.editor.focus()};a.removeHighlights=
function(){a.highlightEntity()};a.getDocumentationForTag=function(a){a=$('element[name="'+a+'"]',writer.schemaXML);return $("a\\:documentation, documentation",a).first().text()};a.init=function(){for(var b=["css/style.css","smoothness/jquery-ui-1.9.0.custom.css","css/layout-default-latest.css","js/snippet/jquery.snippet.css"],d=0;d<b.length;d++){var f=$("<link />");f.attr({rel:"stylesheet",type:"text/css",href:b[d]});$(document.head).append(f)}$(document.body).append('<div id="header" class="ui-layout-north"><h1>CWRC-Writer v0.3</h1></div><div class="ui-layout-west"><div id="westTabs" class="tabs"><ul><li><a href="#entities">Entities</a></li><li><a href="#structure">Structure</a></li><li><a href="#relations">Relations</a></li></ul><div id="westTabsContent" class="ui-layout-content"></div></div></div><div id="main" class="ui-layout-center"><div class="ui-layout-center"><form method="post" action=""><textarea id="editor" name="editor" class="tinymce"></textarea></form></div><div class="ui-layout-south"><div id="southTabs" class="tabs"><ul><li><a href="#validation">Validation</a></li></ul><div id="southTabsContent" class="ui-layout-content"></div></div></div></div>');
a.layout=$(document.body).layout({defaults:{maskIframesOnResize:!0,resizable:!0,slidable:!1},north:{size:27,resizable:!1,spacing_open:0,spacing_closed:0},west:{size:"auto",minSize:250,onresize:function(a,b,d){a=$("#westTabs > ul").outerHeight();$("#westTabsContent").height(d.layoutHeight-a)}}});a.layout.panes.center.layout({defaults:{maskIframesOnResize:!0,resizable:!0,slidable:!1},center:{onresize:function(b,d,c){b=$("#"+a.editor.id+"_tbl tr.mceFirst").outerHeight()+2;$("#"+a.editor.id+"_ifr").height(c.layoutHeight-
b)}},south:{size:250,initClosed:!0,onopen_start:function(){var a=$("#southTabs");a.hasClass("ui-tabs")||a.tabs({create:function(){a.parent().find("div.ui-corner-all, ul.ui-corner-all").removeClass("ui-corner-all")}})},onresize:function(a,b,d){a=$("#southTabs > ul").outerHeight();$("#southTabsContent").height(d.layoutHeight-a)}}});$("#header h1").click(function(){window.location="index.htm"});a.mode=null!=a.mode&&"xml"==a.mode?a.XML:a.XMLRDF;a.d=new DialogManager({writer:a});a.u=new Utilities({writer:a});
a.fm=new FileManager({writer:a});a.tree=new StructureTree({writer:a,parentId:"#westTabsContent"});a.entitiesList=new EntitiesList({writer:a,parentId:"#westTabsContent"});a.em=new EntitiesModel;a.relations=new Relations({writer:a,parentId:"#westTabsContent"});a.validation=new Validation({writer:a,parentId:"#southTabsContent"});a.settings=new SettingsDialog(a,{showEntityBrackets:!0,showStructBrackets:!1});$(document.body).click(c);$("#westTabs").tabs({create:function(){$("#westTabs").parent().find(".ui-corner-all").removeClass("ui-corner-all")}});
a._initEditor()};a._initEditor=function(){$("#editor").tinymce({script_url:"js/tinymce/jscripts/tiny_mce/tiny_mce.js",theme:"advanced",content_css:"css/editor.css",width:"100%",contextmenu_never_use_native:!0,doctype:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',element_format:"xhtml",forced_root_block:a.root,keep_styles:!1,paste_auto_cleanup_on_paste:!0,paste_postprocess:function(a,b){function d(a,b){"p"!=b.nodeName.toLowerCase()&&
"br"!=b.nodeName.toLowerCase()?0==$(b).contents().length?$(b).remove():$(b).contents().unwrap().not(":text").each(d):$(b).children().each(d)}function c(a,b){"p"==b.nodeName.toLowerCase()?$(b).contents().unwrap().wrapAll('<span _tag="p"></span>').not(":text").each(c):"br"==b.nodeName.toLowerCase()&&$(b).replaceWith('<span _tag="lb"></span>')}$(b.node).children().each(d);$(b.node).children().each(c)},valid_elements:"*[*]",plugins:"paste,-entitycontextmenu,-schematags,-currenttag,-viewsource",theme_advanced_buttons1:"schematags,|,addperson,addplace,adddate,addevent,addorg,addcitation,addnote,addtitle,addcorrection,addkeyword,addlink,|,editTag,removeTag,|,addtriple,|,viewsource,editsource,|,validate,newbutton,savebutton,saveasbutton,loadbutton",
theme_advanced_buttons2:"currenttag",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_path:!1,theme_advanced_statusbar_location:"none",setup:function(c){a.editor=c;c.writer=a;c.currentEntity=null;c.currentStruct=null;c.currentBookmark=null;c.currentNode=null;c.entityCopy=null;c.contextMenuPos=null;c.onInit.add(b);c.onChange.add(i);c.onNodeChange.add(d);c.onPaste.add(k);c.addCommand("getSchema",function(){return a.schema});for(var f=
["schematags","currenttag","entitycontextmenu","viewsource","scrolling_dropmenu"],n=0;n<f.length;n++){var p=f[n];tinymce.PluginManager.load(p,"../../../tinymce_plugins/"+p+".js")}c.addButton("addperson",{title:"Tag Person",image:"img/user.png","class":"entityButton person",onclick:function(){c.execCommand("addEntity","person")}});c.addButton("addplace",{title:"Tag Place",image:"img/world.png","class":"entityButton place",onclick:function(){c.execCommand("addEntity","place")}});c.addButton("adddate",
{title:"Tag Date",image:"img/calendar.png","class":"entityButton date",onclick:function(){c.execCommand("addEntity","date")}});c.addButton("addevent",{title:"Tag Event",image:"img/cake.png","class":"entityButton event",onclick:function(){c.execCommand("addEntity","event")}});c.addButton("addorg",{title:"Tag Organization",image:"img/group.png","class":"entityButton org",onclick:function(){c.execCommand("addEntity","org")}});c.addButton("addcitation",{title:"Tag Citation",image:"img/vcard.png","class":"entityButton citation",
onclick:function(){c.execCommand("addEntity","citation")}});c.addButton("addnote",{title:"Tag Note",image:"img/note.png","class":"entityButton note",onclick:function(){c.execCommand("addEntity","note")}});c.addButton("addcorrection",{title:"Tag Correction",image:"img/error.png","class":"entityButton correction",onclick:function(){c.execCommand("addEntity","correction")}});c.addButton("addkeyword",{title:"Tag Keyword",image:"img/page_key.png","class":"entityButton keyword",onclick:function(){c.execCommand("addEntity",
"keyword")}});c.addButton("addlink",{title:"Tag Link",image:"img/link.png","class":"entityButton link",onclick:function(){c.execCommand("addEntity","link")}});c.addButton("addtitle",{title:"Tag Text/Title",image:"img/book.png","class":"entityButton textTitle",onclick:function(){c.execCommand("addEntity","title")}});c.addButton("editTag",{title:"Edit Tag",image:"img/tag_blue_edit.png","class":"entityButton",onclick:function(){c.execCommand("editTag")}});c.addButton("removeTag",{title:"Remove Tag",
image:"img/tag_blue_delete.png","class":"entityButton",onclick:function(){c.execCommand("removeTag")}});c.addButton("newbutton",{title:"New",image:"img/page_white_text.png","class":"entityButton",onclick:function(){a.fm.newDocument()}});c.addButton("savebutton",{title:"Save",image:"img/save.png",onclick:function(){a.fm.validate(!0)}});c.addButton("saveasbutton",{title:"Save As",image:"img/save_as.png",onclick:function(){a.fm.openSaver()}});c.addButton("loadbutton",{title:"Load",image:"img/folder_page.png",
"class":"entityButton",onclick:function(){a.fm.openLoader()}});c.addButton("editsource",{title:"Edit Source",image:"img/editsource.gif","class":"wideButton",onclick:function(){a.fm.editSource()}});c.addButton("validate",{title:"Validate",image:"img/validate.png","class":"entityButton",onclick:function(){a.fm.validate()}});c.addButton("addtriple",{title:"Add Relation",image:"img/chart_org.png","class":"entityButton",onclick:function(){$("#westTabs").tabs("select",2);a.d.show("triple")}})}})};return a};var AddEventDialog=function(){$(document.body).append('<div id="addEventDialog"><div><label>Event Name</label><input type="text" name="eventname" value=""/></div><div style="float: right; width: 100px;"><input type="radio" name="addDateType" value="date" id="add_type_date" checked="checked"/><label for="add_type_date">Date</label><br/><input type="radio" name="addDateType" value="range" id="add_type_range"/><label for="add_type_range">Date Range</label></div><div id="addDate"><label for="addDatePicker">Date</label><input type="text" id="addDatePicker" /></div><div id="addRange"><label for="addStartDate">Start Date</label><input type="text" id="addStartDate" style="margin-bottom: 5px;"/><br /><label for="addEndDate">End Date</label><input type="text" id="addEndDate" /></div><p>Format: yyyy or yyyy-mm-dd<br/>e.g. 2010, 2010-10-05</p><button>Add Further Information</button><p>Note: for DEMO purposes only. Saves are NOT permanent.</div>');
var e=$("#addEventDialog");e.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#addEventDialog").parent().find(".ui-dialog-titlebar-close").hide()},title:"Create New Event",height:300,width:400,autoOpen:!1,buttons:{"Submit for Review":function(){alert("New records can't be added yet. The popup is here only to solicit feedback.");e.dialog("close")},Cancel:function(){e.dialog("close")}}});$("#addEventDialog > button").button();var a=$("#addDatePicker")[0];$(a).focus(function(){$(this).css({borderBottom:""})});
$('#addEventDialog input[name="addDateType"]').change(function(){var a=this.id.split("_")[2];f(a)});$("#addEventDialog input").keyup(function(a){"13"==a.keyCode&&a.preventDefault()});$("#addDatePicker").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1,changeMonth:!0,changeYear:!0,yearRange:"-210:+10",minDate:new Date(1800,0,1),maxDate:new Date(2020,11,31),showOn:"button",buttonText:"Date Picker",buttonImage:"img/calendar.png",buttonImageOnly:!0});var b=$("#addStartDate")[0];$(b).focus(function(){$(this).css({borderBottom:""})});
var h=$("#addEndDate")[0];$(h).focus(function(){$(this).css({borderBottom:""})});var j=$("#addStartDate, #addEndDate").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1,changeMonth:!0,changeYear:!0,yearRange:"-210:+10",minDate:new Date(1800,0,1),maxDate:new Date(2020,11,31),showOn:"button",buttonText:"Date Picker",buttonImage:"img/calendar.png",buttonImageOnly:!0,onSelect:function(a){var b="startDate"==this.id?"minDate":"maxDate",f=$(this).data("datepicker"),a=$.datepicker.parseDate(f.settings.dateFormat||
$.datepicker._defaults.dateFormat,a,f.settings);j.not(this).datepicker("option",b,a)}}),f=function(a){"date"==a?($("#addDate").show(),$("#addRange").hide()):($("#addDate").hide(),$("#addRange").show())};return{show:function(){f("date");$("#add_type_date").attr("checked",!0);$(a).css({borderBottom:""});$(b).css({borderBottom:""});$(h).css({borderBottom:""});$("#addEventDialog input").val("");e.dialog("open")},hide:function(){e.dialog("close")}}},AddOrganizationDialog=function(){$(document.body).append('<div id="addOrganizationDialog"><div><label>Organization Name</label><input type="text" name="placename" value=""/></div><div><label>Type</label><select name="type"><option value="">Corporation</option><option value="">Government</option><option value="">Non-governmental</option><option value="">International</option><option value="">Charity</option><option value="">Not-for-profit corporation</option><option value="">Cooperative</option><option value="">University</option></select></div><button>Add Further Information</button><p>Note: for DEMO purposes only. Saves are NOT permanent.</div>');
var e=$("#addOrganizationDialog");e.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#addOrganizationDialog").parent().find(".ui-dialog-titlebar-close").hide()},title:"Create New Organization",height:300,width:400,autoOpen:!1,buttons:{"Submit for Review":function(){alert("New records can't be added yet. The popup is here only to solicit feedback.");e.dialog("close")},Cancel:function(){e.dialog("close")}}});$("#addOrganizationDialog > button").button();return{show:function(){$("#addOrganizationDialog input").val("");
e.dialog("open")},hide:function(){e.dialog("close")}}},AddPersonDialog=function(){$(document.body).append('<div id="addPersonDialog"><div id="personName"><label>Name</label><input type="text" name="first" value=""/><input type="text" name="middle" value=""/><input type="text" name="maiden" value=""/><input type="text" name="last" value=""/></div><div><label for="dob">Date of Birth (if known)</label><input type="text" id="dob" style="margin-bottom: 5px;"/><br /><label for="dod">Date of Death (if known)</label><input type="text" id="dod" /><p>Format: yyyy-mm-dd<br/>e.g. 2010-10-05</p></div><div><label>Occupation (if known)</label><select name="occupation"><option></option><option>Author</option><option>Teacher</option><option>Engineer</option></select></div><button>Add Further Information</button><p>Note: for DEMO purposes only. Saves are NOT permanent.</div>');
var e=$("#addPersonDialog");e.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#addPersonDialog").parent().find(".ui-dialog-titlebar-close").hide()},title:"Create New Person",height:350,width:465,autoOpen:!1,buttons:{"Submit for Review":function(){alert("New records can't be added yet. The popup is here only to solicit feedback.");e.dialog("close")},Cancel:function(){e.dialog("close")}}});$("#dob, #dod").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1,changeMonth:!0,changeYear:!0,
yearRange:"-210:+10",minDate:new Date(1800,0,1),maxDate:new Date(2020,11,31),showOn:"button",buttonText:"Date Picker",buttonImage:"img/calendar.png",buttonImageOnly:!0,onSelect:function(a){var b="dob"==this.id?"minDate":"maxDate",h=$(this).data("datepicker"),a=$.datepicker.parseDate(h.settings.dateFormat||$.datepicker._defaults.dateFormat,a,h.settings);dateRange.not(this).datepicker("option",b,a)}});$('#addPersonDialog input[name="first"]').watermark("First");$('#addPersonDialog input[name="middle"]').watermark("Middle");
$('#addPersonDialog input[name="maiden"]').watermark("Maiden");$('#addPersonDialog input[name="last"]').watermark("Last");$("#addPersonDialog > button").button();return{show:function(){$("#addPersonDialog input").val("");$("#addPersonDialog select").val("");e.dialog("open")},hide:function(){e.dialog("close")}}},AddPlaceDialog=function(){$(document.body).append('<div id="addPlaceDialog"><div><label>Place Name</label><input type="text" name="placename" value=""/></div><div><label>Location</label><input type="text" name="location" value=""/></div><button>Add Further Information</button><p>Note: for DEMO purposes only. Saves are NOT permanent.</div>');
var e=$("#addPlaceDialog");e.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#addPlaceDialog").parent().find(".ui-dialog-titlebar-close").hide()},title:"Create New Place",height:300,width:400,autoOpen:!1,buttons:{"Submit for Review":function(){alert("New records can't be added yet. The popup is here only to solicit feedback.");e.dialog("close")},Cancel:function(){e.dialog("close")}}});$("#addPlaceDialog > button").button();return{show:function(){$("#addPlaceDialog input").val("");
e.dialog("open")},hide:function(){e.dialog("close")}}},CitationDialog=function(e){var a=e.writer,b=null,h=null;$(document.body).append('<div id="citationDialog"><textarea name="citation" style="margin-top: 10px;"></textarea><p><b>NB</b>: This popup is not yet functional. Eventually it will let you look up the text to which you want to refer, or to add an entry for a new text.</p></div>');var j=$("#citationDialog");j.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#citationDialog").parent().find(".ui-dialog-titlebar-close").hide()},
height:280,width:380,autoOpen:!1,buttons:{"Tag Citation":function(){i()},Cancel:function(){i(!0)}}});var f=$("#citationDialog textarea")[0],i=function(d){var i=null;d||(i={},i[b]=f.value);1==h&&null!=i?a.editEntity(a.editor.currentEntity,i):a.finalizeEntity(b,i);j.dialog("close");b=null};return{show:function(a){b=a.type;h=a.entry?1:0;var i="Add ";0==h?f.value="":(i="Edit ",f.value=a.entry.info[b]);j.dialog("option","title",i+a.title);a.pos?j.dialog("option","position",[a.pos.x,a.pos.y]):j.dialog("option",
"position","center");j.dialog("open")},hide:function(){j.dialog("close")}}},CorrectionDialog=function(e){var a=e.writer,b=null,h=null;$(document.body).append('<div id="correctionDialog"><div><p>Correction</p><textarea id="correctionInput" name="correction"></textarea></div><div id="corr_cert"><p>Certainty</p><input type="radio" id="corr_definite" name="certainty" value="definite" /><label for="corr_definite">Definite</label><input type="radio" id="corr_reasonable" name="certainty" value="reasonable" /><label for="corr_reasonable">Reasonably Certain</label><input type="radio" id="corr_probable" name="certainty" value="probable" /><label for="corr_probable">Probable</label><input type="radio" id="corr_speculative" name="certainty" value="speculative" /><label for="corr_speculative">Speculative</label></div><div id="corr_type"><p>Type</p><input type="radio" id="corr_ocr" name="type" value="ocr" /><label for="corr_ocr">OCR</label><input type="radio" id="corr_typo" name="type" value="typographical" /><label for="corr_typo">Typographical</label><input type="radio" id="corr_other" name="type" value="other" /><label for="corr_other">Other</label></div></div>');
var j=$("#correctionDialog");j.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#correctionDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:355,width:385,autoOpen:!1,buttons:{"Tag Correction":function(){i()},Cancel:function(){i(!0)}}});var f=$("#correctionDialog textarea")[0];$("#corr_cert, #corr_type").buttonset();var i=function(d){var i=null;d||(i={content:f.value,certainty:$("#corr_cert input:checked").val(),type:$("#corr_type input:checked").val()});1==h&&null!=
i?a.editEntity(a.editor.currentEntity,i):a.finalizeEntity(b,i);j.dialog("close");b=null};return{show:function(a){b=a.type;h=a.entry?1:0;var i="Add ";0==h?(f.value="",$("#corr_cert input:eq(0)").click(),$("#corr_type input:eq(0)").click()):(i="Edit ",f.value=a.entry.info.content,$('#corr_cert input[value="'+a.entry.info.certainty+'"]').click(),$('#corr_type input[value="'+a.entry.info.type+'"]').click());j.dialog("option","title",i+a.title);a.pos?j.dialog("option","position",[a.pos.x,a.pos.y]):j.dialog("option",
"position","center");j.dialog("open")},hide:function(){j.dialog("close")}}},DateDialog=function(e){var a=e.writer,b=null;$(document.body).append('<div id="dateDialog"><div style="float: right; width: 100px;"><input type="radio" name="dateType" value="date" id="type_date" checked="checked"/><label for="type_date">Date</label><br/><input type="radio" name="dateType" value="range" id="type_range"/><label for="type_range">Date Range</label></div><div id="date"><label for="datePicker">Date</label><input type="text" id="datePicker" /></div><div id="range"><label for="startDate">Start Date</label><input type="text" id="startDate" style="margin-bottom: 5px;"/><br /><label for="endDate">End Date</label><input type="text" id="endDate" /></div><p>Format: yyyy or yyyy-mm-dd<br/>e.g. 2010, 2010-10-05</p></div>');
var h=$("#dateDialog");h.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#dateDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:200,width:375,autoOpen:!1,buttons:{"Tag Date":function(){c()},Cancel:function(){c(!0)}}});var j=$("#datePicker")[0];$(j).focus(function(){$(this).css({borderBottom:""})});$('#dateDialog input[name="dateType"]').change(function(){var a=this.id.split("_")[1];k(a)});$("#dateDialog input").keyup(function(a){"13"==a.keyCode&&(a.preventDefault(),
c())});$("#datePicker").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1,changeMonth:!0,changeYear:!0,yearRange:"-210:+10",minDate:new Date(1800,0,1),maxDate:new Date(2020,11,31),showOn:"button",buttonText:"Date Picker",buttonImage:"img/calendar.png",buttonImageOnly:!0});var f=$("#startDate")[0];$(f).focus(function(){$(this).css({borderBottom:""})});var i=$("#endDate")[0];$(i).focus(function(){$(this).css({borderBottom:""})});var d=$("#startDate, #endDate").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1,
changeMonth:!0,changeYear:!0,yearRange:"-210:+10",minDate:new Date(1800,0,1),maxDate:new Date(2020,11,31),showOn:"button",buttonText:"Date Picker",buttonImage:"img/calendar.png",buttonImageOnly:!0,onSelect:function(a){var b="startDate"==this.id?"minDate":"maxDate",c=$(this).data("datepicker"),a=$.datepicker.parseDate(c.settings.dateFormat||$.datepicker._defaults.dateFormat,a,c.settings);d.not(this).datepicker("option",b,a)}}),k=function(a){"date"==a?($("#date").show(),$("#range").hide()):($("#date").hide(),
$("#range").show())},c=function(c){var d={};if(c)d=null;else if("date"==$("#type_date:checked").val())if(c=j.value,c.match(/^\d{4}-\d{2}-\d{2}$/)||c.match(/^\d{4}$/))d.date=c;else return $(j).css({borderBottom:"1px solid red"}),!1;else{var k=f.value,e=i.value,c=!1,g="",r="";k.match(/^\d{4}-\d{2}-\d{2}$/)?d.startDate=k:k.match(/^\d{4}$/)?(d.startDate=k,g="-01-01"):($(f).css({borderBottom:"1px solid red"}),c=!0);e.match(/^\d{4}-\d{2}-\d{2}$/)?d.endDate=e:e.match(/^\d{4}$/)?(d.endDate=e,r="-01-01"):
($(i).css({borderBottom:"1px solid red"}),c=!0);k=$.datepicker.parseDate("yy-mm-dd",k+g);e=$.datepicker.parseDate("yy-mm-dd",e+r);k>e&&($(f).css({borderBottom:"1px solid red"}),$(i).css({borderBottom:"1px solid red"}),c=!0);if(c)return!1}1==b&&null!=d?a.editEntity(a.editor.currentEntity,d):a.finalizeEntity("date",d);h.dialog("close")};return{show:function(c){b=c.entry?1:0;var d="Tag ";if(0==b){var e="",l=a.editor.currentBookmark.rng.toString(),g=moment(l).toDate(),r=g.getFullYear();isNaN(r)||(4<l.length?
(e=g.getMonth(),e++,10>e&&(e="0"+e),g=g.getDate(),10>g&&(g="0"+g),e=r+"-"+e+"-"+g):(r++,e=r));k("date");$("#type_date").attr("checked",!0);j.value=e;f.value="";i.value=""}else d="Edit ",r=c.entry.info,r.date?(k("date"),$("#type_date").attr("checked",!0),j.value=r.date,f.value="",i.value=""):(k("range"),$("#type_date").attr("checked",!1),j.value="",f.value=r.startDate,i.value=r.endDate);$(j).css({borderBottom:""});$(f).css({borderBottom:""});$(i).css({borderBottom:""});h.dialog("option","title",d+
c.title);c.pos?h.dialog("option","position",[c.pos.x,c.pos.y]):h.dialog("option","position","center");h.dialog("open");$(j).focus()},hide:function(){h.dialog("close")}}},HeaderDialog=function(e){function a(){var a="";$(b.editor.getBody()).find('span[_tag="'+b.header+'"]').children().each(function(f,i){a+=b.fm.buildXMLString($(i))});$("#header_textarea").val(a);h.dialog("open")}var b=e.writer;$("#header").append('<div id="headerLink"><h2>Edit Header</h2></div>');$(document.body).append('<div id="headerDialog"><textarea id="header_textarea" style="width: 100%; height: 98%;"></textarea></div></div>');
var h=$("#headerDialog");h.dialog({title:"Edit Header",modal:!0,resizable:!0,height:380,width:400,autoOpen:!1,buttons:{Ok:function(){var a="<head>"+$("#header_textarea").val()+"</head>",f;try{f=$.parseXML(a)}catch(i){return b.d.show("message",{title:"Invalid XML",msg:"There was an error parsing the XML.",type:"error"}),!1}var d="";$(f).find("head").children().each(function(a,c){d+=b.fm.buildEditorString(c)});$(b.editor.getBody()).find('span[_tag="'+b.header+'"]').html(d);h.dialog("close")},Cancel:function(){h.dialog("close")}}});
$("#headerLink").click(function(){a()});return{show:function(){a()},hide:function(){h.dialog("close")}}},KeywordDialog=function(e){var a=e.writer,b=null,h=null;$(document.body).append('<div id="keywordDialog"><div id="keyword_choice"><div id="keyword_key"><h3>Keyword</h3><div><label for="keyword_input">Keyword</label><input type="text" id="keyword_input" /></div></div><div id="keyword_index"><h3>Index Term</h3><div><label for="keyword_lookup">OCLC Lookup</label><input type="text" id="keyword_lookup" /><ul class="searchResults" style="overflow: auto; border: 1px solid #fff;"></ul></div></div></div></div>');
$("#keyword_choice").accordion({header:"div > h3",fillSpace:!0});var j=$("#keywordDialog");j.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#keywordDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:400,width:400,autoOpen:!1,buttons:{"Tag Keyword":function(){f()},Cancel:function(){f(!0)}}});$("#keyword_lookup").keyup(function(){var b='oclcts.preferredTerm="'+$(this).val()+'"';$.ajax({url:a.baseUrl+"services/ts-oclc/lcsh/",data:{query:b,version:"1.1",operation:"searchRetrieve",
recordSchema:"http://www.w3.org/2004/02/skos/core",recordPacking:"xml",maximumRecords:"15",startRecord:"1"},type:"GET",dataType:"xml",success:function(a){var b=$("record",a),c=$("#keyword_index ul");c.empty();if(0==b.length)c.html('<li class="unselectable last"><span>No results.</span></li>');else{var i=[],e=[],h="";b.each(function(a,c){var d=$("skos\\:prefLabel, prefLabel",c).text(),f=$("dct\\:identifier, identifier",c).first().text(),p=$("dct\\:type, type",c).last().text(),j="";a==b.length-1&&(j=
"last");i.push(f);e.push(p);h+='<li class="unselectable '+j+'"><span>'+d+"</span></li>"});c.html(h);$("li",c).each(function(a){$(this).data("id",i[a]);$(this).data("type",e[a]);$(this).data("title",$(this).text())});$("li",c).click(function(){c.css({borderColor:"#fff"});var a=$(this).hasClass("selected");$("li",c).removeClass("selected");a||$(this).addClass("selected")});$("li",c).dblclick(function(){$("li",c).removeClass("selected");$(this).addClass("selected");f()})}a=c.parents("div.ui-accordion-content").height();
c.height(a-20)},error:function(a,b,c){alert(c)}})});var f=function(f){var d=null;if(!f)if("keyword_key"==$("#keywordDialog div.ui-accordion-content-active").parent()[0].id)d={type:"keyword",keyword:$("#keyword_input").val()};else{if(d=$("#keywordDialog div.ui-accordion-content-active ul li.selected").data())for(var e in d)e.match(/jQuery/)&&delete d[e];else return $("#keywordDialog div.ui-accordion-content-active ul").css({borderColor:"red"}),!1;d.lookup=$("#keyword_lookup").val();d.type="lookup"}1==
h&&null!=d?a.editEntity(a.editor.currentEntity,d):a.finalizeEntity(b,d);j.dialog("close");b=null};return{show:function(a){b=a.type;h=a.entry?1:0;j.dialog("option","title","Add "+a.title);a.pos?j.dialog("option","position",[a.pos.x,a.pos.y]):j.dialog("option","position","center");j.dialog("open");$("#keyword_input").val("");$("#keyword_lookup").val("");$("#keyword_index ul").css({borderColor:"#fff"}).empty();$("#keyword_choice").accordion("resize");0==h?$("#keyword_choice").accordion("activate",0):
"keyword"==a.entry.info.type?($("#keyword_choice").accordion("activate",0),$("#keyword_input").val(a.entry.info.keyword)):($("#keyword_choice").accordion("activate",1),$("#keyword_lookup").val(a.entry.info.lookup))},hide:function(){j.dialog("close")}}},LinkDialog=function(e){var a=e.writer,b=null,h=null;$(document.body).append('<div id="linkDialog"><div><label for="link_input">HTTP Link</label><input type="text" id="link_input" style="margin-right: 10px;"/><button>Check Link</button></div></div>');
var j=$("#linkDialog");j.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#linkDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:125,width:345,autoOpen:!1,buttons:{"Tag Link":function(){f()},Cancel:function(){f(!0)}}});$("#linkDialog button").button().click(function(){var a=$("#link_input").val();""!=a&&(null==a.match(/^https?:\/\//)&&(a="http://"+a),window.open(a,"linkTestWindow"))});var f=function(f){var d=null;f||(d={url:$("#link_input").val()});1==h&&null!=d?
a.editEntity(a.editor.currentEntity,d):a.finalizeEntity(b,d);j.dialog("close");b=null};return{show:function(a){b=a.type;h=a.entry?1:0;var d="Add ";0==h?$("#link_input").val("http://"):(d="Edit ",$("#link_input").val(a.entry.info.url));j.dialog("option","title",d+a.title);a.pos?j.dialog("option","position",[a.pos.x,a.pos.y]):j.dialog("option","position","center");j.dialog("open")},hide:function(){j.dialog("close")}}},MessageDialog=function(){$(document.body).append('<div id="messageDialog"><p><span class="ui-state-highlight" style="border: none;"><span style="float: left; margin-right: 4px;" class="ui-icon ui-icon-info"></span></span><span class="ui-state-error" style="border: none;"><span style="float: left; margin-right: 4px;" class="ui-icon ui-icon-alert"></span></span><span class="message"></span></p></div>');
var e=$("#messageDialog");e.dialog({modal:!0,resizable:!0,closeOnEscape:!0,height:250,width:300,autoOpen:!1});return{show:function(a){var b=a.title,h=a.msg,j=null==a.modal?!0:a.modal,a=a.type;$("#messageDialog > p > span[class^=ui-state]").hide();"info"==a?$("#messageDialog > p > span[class=ui-state-highlight]").show():"error"==a&&$("#messageDialog > p > span[class=ui-state-error]").show();e.dialog("option","title",b);e.dialog("option","modal",j);e.dialog("option","buttons",{Ok:function(){e.dialog("close")}});
$("#messageDialog > p > span[class=message]").html(h);e.dialog("open")},confirm:function(a){var b=a.title,h=a.msg,j=a.callback;$("#messageDialog > p > span[class^=ui-state]").hide();e.dialog("option","title",b);e.dialog("option","buttons",{Yes:function(){j(!0);e.dialog("close")},No:function(){j(!1);e.dialog("close")}});$("#messageDialog > p > span[class=message]").html(h);e.dialog("open")},hide:function(){e.dialog("close")}}},NoteDialog=function(e){var a=e.writer,b=null,h=null,j=null;$(document.body).append('<div id="noteDialog"><div id="note_type"><p>Type</p><input type="radio" id="note_re" name="type" value="research" /><label for="note_re" title="Internal to projects">Research Note</label><input type="radio" id="note_scho" name="type" value="scholarly" /><label for="note_scho" title="Footnotes/endnotes">Scholarly Note</label><input type="radio" id="note_ann" name="type" value="annotation" /><label for="note_ann" title="Informal notes">Annotation</label><input type="radio" id="note_trans" name="type" value="translation" /><label for="note_trans">Translation</label></div><textarea id="note_textarea"></textarea><div id="note_access"><p>Access</p><input type="radio" id="note_pub" name="access" value="public" /><label for="note_pub">Public</label><input type="radio" id="note_pro" name="access" value="project" /><label for="note_pro">Project</label><input type="radio" id="note_pri" name="access" value="private" /><label for="note_pri">Private</label></div></div>');
var f=$("#noteDialog");f.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#noteDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:450,width:405,autoOpen:!1,buttons:{"Tag Note":function(){i()},Cancel:function(){i(!0)}}});$("#note_type, #note_access").buttonset();$("#note_textarea").tinymce({script_url:"js/tinymce/jscripts/tiny_mce/tiny_mce.js",height:"225",width:"380",theme:"advanced",theme_advanced_buttons1:"bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,bullist,numlist,|,formatselect",
theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_path:!1,theme_advanced_statusbar_location:"none",setup:function(a){b=a}});var i=function(d){var i=null;d||(i={content:a.u.escapeHTMLString(b.getContent()),type:$("#note_type input:checked").val(),access:$("#note_access input:checked").val()});tinyMCE.activeEditor=tinyMCE.selectedInstance=a.editor;1==j&&null!=i?a.editEntity(a.editor.currentEntity,i):a.finalizeEntity(h,
i);f.dialog("close");h=null};return{show:function(d){h=d.type;j=d.entry?1:0;var i="Add ";if(0==j)$("#note_type input:eq(0)").click(),$("#note_access input:eq(0)").click(),b.setContent("");else{i="Edit ";$('#note_type input[value="'+d.entry.info.type+'"]').click();$('#note_access input[value="'+d.entry.info.access+'"]').click();var c=a.u.unescapeHTMLString(d.entry.info.content);b.setContent(c)}f.dialog("option","title",i+d.title);d.pos?f.dialog("option","position",[d.pos.x,d.pos.y]):f.dialog("option",
"position","center");f.dialog("open")},hide:function(){f.dialog("close")}}},SearchDialog=function(e){var a=e.writer,b=null,h=null;$(document.body).append('<div id="searchDialog"><div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 31px;"><label for="search_query">Search</label><input type="text" name="query" id="search_query" /></div><div style="position: absolute; top: 41px; left: 10px; right: 10px; bottom: 70px;"><div id="lookupServices"><div id="lookup_project"><h3>Results from '+
a.project+' Project</h3><div><div class="searchResultsParent"><ul class="searchResults"></ul></div></div></div><div id="lookup_viaf"><h3>Results from Web</h3><div><div class="searchResultsParent"><ul class="searchResults"></ul></div></div></div><div id="lookup_alternate"><h3>Alternate Identifier</h3><div><div><input type="radio" name="altLookup" /><label for="search_name">Name</label><ins name="name" class="ui-icon ui-icon-help">&nbsp;</ins><br/><input type="text" name="name" id="search_name" /></div><div><input type="radio" name="altLookup" /><label for="search_localid">Local Identifier</label><ins name="localid" class="ui-icon ui-icon-help">&nbsp;</ins><br/><input type="text" name="localid" id="search_localid" /></div><div><input type="radio" name="altLookup" /><label for="search_uri">URI</label><ins name="uri" class="ui-icon ui-icon-help">&nbsp;</ins><br/><input type="text" name="uri" id="search_uri" /></div></div></div></div></div><div id="certainty" style="position: absolute; bottom: 0; left: 10px; right: 10px; height: 65px;"><p>This identification is:</p><input type="radio" id="c_definite" name="certainty" value="definite" /><label for="c_definite">Definite</label><input type="radio" id="c_reasonable" name="certainty" value="reasonable" /><label for="c_reasonable">Reasonably Certain</label><input type="radio" id="c_speculative" name="certainty" value="speculative" /><label for="c_speculative">Speculative</label></div></div>');
var j=$("#searchDialog");j.dialog({modal:!0,resizable:!1,dialogClass:"splitButtons",closeOnEscape:!1,open:function(){$("#searchDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:550,width:400,autoOpen:!1});var f=$("#search_query")[0];$(f).bind("keyup",function(){i()});$("#lookupServices").accordion({header:"div > h3",fillSpace:!0,activate:function(){2>$("#lookupServices").accordion("option","active")&&i()}});$("#lookup_alternate ins").click(function(){var b=$(this).attr("name"),d=
"";"name"==b?d="Enter a first and last name, which will be encoded as a FOAF URN.":"localid"==b?d="Enter the local id that you system uses for this person. It will be encoded as an URN.":"uri"==b&&(d="Enter a resolvable URI that identifies this person, e.g. their VIAF URI, LOC URI, etc.");a.d.show("message",{title:"Help",msg:d,modal:!1})});$('#lookup_alternate input[type="text"]').focus(function(){$(this).prevAll("input").prop("checked",!0)}).keyup(function(){$(this).css({borderColor:"#ccc"})});$("#certainty").buttonset();
var i=function(){var c=$("#lookupServices div.ui-accordion-content-active").parent()[0].id;$("#lookupServices div.ui-accordion-content-active div.searchResultsParent").css({borderColor:"#fff"});$("#lookupServices div.ui-accordion-content-active ul").first().html('<li class="unselectable last"><span>Searching...</span></li>');var i=f.value;if("lookup_project"==c)$.ajax({url:a.baseUrl+"services/entity_lookup/uap",data:{q:"authlabel:"+i,d:"orlando",f:"by_auth_label",v:"auth_label"},dataType:"text json",
success:function(a){$.isPlainObject(a)&&(a=[a]);null!=a?d(a,"project"):$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html('<li class="unselectable last"><span>No results.</span></li>')},error:function(a,b){if("parsererror"==b){var c=a.responseText.split(/\n/);""==c[c.length-1]&&c.pop();c=c.join(",");c=$.parseJSON("["+c+"]");d(c,"project")}else $("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html('<li class="unselectable last"><span>Server error.</span></li>')}});
else if("lookup_viaf"==c)$.ajax({url:"http://viaf.org/viaf/AutoSuggest",data:{query:i},dataType:"jsonp",success:function(a){null!=a&&null!=a.result?d(a.result,"viaf"):$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html('<li class="unselectable last"><span>No results.</span></li>')},error:function(){$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html('<li class="unselectable last"><span>Server error.</span></li>')}});
else if("lookup_orca"==c){for(var c=[],i=Math.ceil(10*Math.random()),e=0;e<i;e++){var h={date:(new Date(Math.round(1E12*Math.random()))).toDateString()};h[b]="Random "+b+" "+e;c.push(h)}d(c)}},d=function(a,d){var f="",i="";if(0==a.length)$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html('<li class="unselectable last"><span>No results.</span></li>');else{var e,g;for(e=0;e<a.length;e++)i=a[e],g="project"==d?i.entry.authorityLabel:"viaf"==d?i.term:i[b],i=e==
a.length-1?"last":"",f+='<li class="unselectable '+i+'">',f+="<span>"+g+"</span>",f+="</li>";$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul").first().html(f);$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul li").each(function(b){$(this).data(a[b])});$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul li").click(function(){$("#lookupServices div.ui-accordion-content-active div.searchResultsParent").css({borderColor:"#fff"});
var a=$(this).hasClass("selected");$("#lookupServices div.ui-accordion-content-active ul li").removeClass("selected");a||$(this).addClass("selected")});$("#lookupServices div.ui-accordion-content-active div.searchResultsParent ul li").dblclick(function(){$("#lookupServices div.ui-accordion-content-active ul li").removeClass("selected");$(this).addClass("selected");k()})}},k=function(c){var d=null;if(!c){if("lookup_alternate"==$("#lookupServices div.ui-accordion-content-active").parent()[0].id)if(c=
$('#lookup_alternate input[name="altLookup"]:checked'),1==c.length){d=c.nextAll("input").val();if(""==d)return $('#lookup_alternate input[type="text"]').css({borderColor:"#ccc"}),c.nextAll("input").css({borderColor:"red"}),!1;d={type:"alt_id",typeName:c.nextAll("input").attr("name"),value:d}}else return $('#lookup_alternate input[type="text"]').css({borderColor:"#ccc"}),$('#lookup_alternate input[name="altLookup"]').first().prop("checked",!0).nextAll("input").css({borderColor:"red"}),!1;else if(d=
$("#lookupServices div.ui-accordion-content-active ul li.selected").data())for(var f in d)f.match(/jQuery/)&&delete d[f];else return $("#lookupServices div.ui-accordion-content-active div.searchResultsParent").css({borderColor:"red"}),!1;d&&(d.certainty=$("#certainty input:checked").val())}1==h&&null!=d?a.editEntity(a.editor.currentEntity,d):a.finalizeEntity(b,d);j.dialog("close");b=null};return{show:function(c){b=c.type;h=c.entry?1:0;var d="Tag ",e;1==h?(d="Edit ",e=a.entities[a.editor.currentEntity].props.content):
e=a.editor.currentBookmark.rng.toString();$("#lookupServices div.searchResultsParent").css({borderColor:"#fff"}).children("ul").empty();$('#lookup_alternate input[type="text"]').css({borderColor:"#ccc"}).val("");f.value=e;j.dialog("option","title",d+c.title);j.dialog("option","buttons",[{text:"Cancel",click:function(){k(!0)}},{text:"Add New "+c.title,click:function(){a.d.show("add"+b,{})}},{text:"Tag "+c.title,click:function(){k()}}]);c.pos?j.dialog("option","position",[c.pos.x,c.pos.y]):j.dialog("option",
"position","center");j.dialog("open");$("#lookupServices").accordion("resize");1==h?($('#certainty input[value="'+c.entry.info.certainty+'"]').click(),c.entry.info.type&&"alt_id"==c.entry.info.type?($("#lookupServices").accordion("activate",2),$('#lookup_alternate input[name="'+c.entry.info.typeName+'"]').val(c.entry.info.value).prevAll("input").click()):$("#lookupServices").accordion("activate",0)):($("#c_definite").trigger("click"),0==$("#lookupServices").accordion("option","active")?i():$("#lookupServices").accordion("activate",
0))},hide:function(){j.dialog("close")}}},SettingsDialog=function(e,a){var b={fontSize:"11pt",fontFamily:"Book Antiqua",showEntityBrackets:!1,showStructBrackets:!1};jQuery.extend(b,a);$("#header").append('<div id="helpLink"><img src="img/help.png" title="Help"/><h2>Help</h2></div><div id="settingsLink"><h2>Settings</h2></div>');$(document.body).append('<div id="settingsDialog"><div><label>Font Size</label><select name="fontsize"><option value="9pt">9pt</option><option value="10pt">10pt</option><option value="11pt">11pt</option><option value="12pt">12pt</option><option value="13pt">13pt</option></select></div><div style="margin-top: 10px;"><label>Font Type</label><select name="fonttype"><option value="Arial" style="font-family: Arial; font-size: 12px;">Arial</option><option value="Book Antiqua" style="font-family: Book Antiqua; font-size: 12px;">Book Antiqua</option><option value="Georgia" style="font-family: Georgia; font-size: 12px;">Georgia</option><option value="Helvetica" style="font-family: Helvetica; font-size: 12px;">Helvetica</option><option value="Palatino" style="font-family: Palatino; font-size: 12px;">Palatino</option><option value="Tahoma" style="font-family: Tahoma; font-size: 12px;">Tahoma</option><option value="Times New Roman" style="font-family: Times New Roman; font-size: 12px;">Times New Roman</option><option value="Verdana" style="font-family: Verdana; font-size: 12px;">Verdana</option></select></div><div style="margin-top: 10px;"><label for="showentitybrackets">Show Entity Brackets</label><input type="checkbox" id="showentitybrackets" /></div><div style="margin-top: 10px;"><label for="showstructbrackets">Show Tags</label><input type="checkbox" id="showstructbrackets" /></div><div style="margin-top: 10px;"><label>Editor Mode</label><select name="editormode"><option value="0">XML & RDF (overlapping entities)</option><option value="1">XML (no overlap)</option></select></div><div style="margin-top: 10px;"><label>Schema</label><select name="schema" disabled="disabled"><option value="cwrcbasic">CWRC Basic TEI Schema</option><option value="events">Events Schema</option></select></div></div><div id="helpDialog"></div>');
$("#settingsLink").click(function(){$('select[name="fontsize"] > option[value="'+b.fontSize+'"]',$("#settingsDialog")).attr("selected",!0);$('select[name="fonttype"] > option[value="'+b.fontFamily+'"]',$("#settingsDialog")).attr("selected",!0);$("#showentitybrackets").prop("checked",b.showEntityBrackets);$("#showstructbrackets").prop("checked",b.showStructBrackets);$('select[name="editormode"] > option[value="'+e.mode+'"]',$("#settingsDialog")).attr("selected",!0);$('select[name="schema"] > option[value="'+
e.validationSchema+'"]',$("#settingsDialog")).attr("selected",!0);$("#settingsDialog").dialog("open")});$("#helpLink").click(function(){0==$("#helpDialog iframe").length&&$("#helpDialog").html('<iframe src="https://sites.google.com/site/cwrcwriterhelp/home"/>');$("#helpDialog").dialog("open")});$("#settingsDialog").dialog({title:"Settings",modal:!0,resizable:!1,closeOnEscape:!0,height:270,width:325,autoOpen:!1,buttons:{Ok:function(){var a=parseInt($('select[name="editormode"]',$("#settingsDialog")).val());
if(a!=e.mode){var j=!0,f;if(f=e.mode==e.XMLRDF&&a==e.XML)a:{e.highlightEntity();for(var i in e.entities){var d=e.editor.dom.select('entity[name="'+i+'"]');f=d[1];for(d=d[0];d!=f&&null!=d;)if(d=d.nextSibling,"entity"==d.nodeName.toLowerCase()&&d!=f){f=!0;break a}}f=!1}f&&(j=!1,e.d.show("message",{title:"Error",msg:"You have overlapping entities and are trying to change to XML mode (which doesn't permit overlaps).  Please remove the overlapping entities and try again.",type:"error"}));j&&(e.mode=a)}b.fontSize=
$('select[name="fontsize"]',$("#settingsDialog")).val();b.fontFamily=$('select[name="fonttype"]',$("#settingsDialog")).val();b.showEntityBrackets!=$("#showentitybrackets").prop("checked")&&e.editor.$("body").toggleClass("showEntityBrackets");b.showEntityBrackets=$("#showentitybrackets").prop("checked");b.showStructBrackets!=$("#showstructbrackets").prop("checked")&&e.editor.$("body").toggleClass("showStructBrackets");b.showStructBrackets=$("#showstructbrackets").prop("checked");e.validationSchema=
$('select[name="schema"]',$("#settingsDialog")).val();a={fontSize:b.fontSize,fontFamily:b.fontFamily};e.editor.dom.setStyles(e.editor.dom.getRoot(),a);$("#settingsDialog").dialog("close")},Cancel:function(){$("#settingsDialog").dialog("close")}}});$("#helpDialog").dialog({title:"Help",modal:!0,resizable:!0,closeOnEscape:!0,height:500,width:900,autoOpen:!1,buttons:{Close:function(){$("#helpDialog").dialog("close")}}});return{getSettings:function(){return b}}},TitleDialog=function(e){var a=e.writer,
b=null;$(document.body).append('<div id="titleDialog"><div>Type<br/><input type="radio" value="a" name="level" id="level_a"/><label for="level_a">Analytic <span style="font-size: 8px;">(article, poem, or other item published as part of a larger item)</span></label><br/><input type="radio" value="m" name="level" id="level_m" checked="checked"/><label for="level_m">Monographic <span style="font-size: 8px;">(book, collection, single volume, or other item published as a distinct item)</span></label><br/><input type="radio" value="j" name="level" id="level_j"/><label for="level_j">Journal <span style="font-size: 8px;">(magazine, newspaper or other periodical publication)</span></label><br/><input type="radio" value="s" name="level" id="level_s"/><label for="level_s">Series <span style="font-size: 8px;">(book, radio, or other series)</span></label><br/><input type="radio" value="u" name="level" id="level_u"/><label for="level_u">Unpublished <span style="font-size: 8px;">(thesis, manuscript, letters or other unpublished material)</span></label><br/></div><div>Equivalent title (optional) <input name="alt" type="text" /> <span style="font-size: 8px;">(standard form of title)</span></div><div>Refer to text (optional) <input name="ref" type="text" /></div><div><input type="checkbox" name="unformatted" id="unformatted"/><label for="unformatted">Unformatted</label></div><div><b>NB</b>: This popup is not yet functional. Eventually it will let you look up the text to which you want to refer, or to add an entry for a new text.</div></div>');
var h=$("#titleDialog");h.dialog({modal:!0,resizable:!1,closeOnEscape:!1,open:function(){$("#titleDialog").parent().find(".ui-dialog-titlebar-close").hide()},height:355,width:435,autoOpen:!1,buttons:{"Tag Text/Title":function(){j()},Cancel:function(){j(!0)}}});$("#titleDialog input").keyup(function(a){"13"==a.keyCode&&(a.preventDefault(),j())});var j=function(f){var i=null;if(!f)var f=$('input[name="level"]:checked',h).val(),i=$('input[name="ref"]',h).val(),d=$('input[name="alt"]',h).val(),e=$('input[name="unformatted"]',
h).prop("checked"),i={level:f,ref:i,alt:d,unformatted:e};1==b&&null!=i?a.editEntity(a.editor.currentEntity,i):a.finalizeEntity("title",i);h.dialog("close")};return{show:function(a){b=a.entry?1:0;var i="Tag ";if(0==b)$('input[value="m"]',h).attr("checked",!0),$('input[name="ref"]',h).attr("value",""),$('input[name="alt"]',h).attr("value",""),$('input[name="unformatted"]',h).attr("checked",!1);else{var i="Edit ",d=a.entry.info.ref,e=a.entry.info.alt,c=a.entry.info.unformatted;$('input[value="'+a.entry.info.level+
'"]',h).attr("checked",!0);$('input[name="ref"]',h).attr("value",d);$('input[name="alt"]',h).attr("value",e);$('input[name="unformatted"]',h).attr("checked",c)}h.dialog("option","title",i+a.title);a.pos?h.dialog("option","position",[a.pos.x,a.pos.y]):h.dialog("option","position","center");h.dialog("open")},hide:function(){h.dialog("close")}}},TripleDialog=function(e){var a=e.writer,b={person:["is a child of","is a parent of","is related to","was born on","died on"],place:["is located within","contains"]};
$(document.body).append('<div id="tripleDialog"><div id="tripleColumnsParent"><div id="subjectColumn" class="column"><h2>Subject</h2><ul class="entitiesList"></ul><div class="customEntry"><input type="text" name="customSubject" value="" /></div></div><div id="predicateColumn" class="column"><h2>Predicate</h2><ul></ul><div class="customEntry"><input type="text" name="customPredicate" value="" /></div></div><div id="objectColumn" class="column"><h2>Object</h2><ul class="entitiesList"></ul><div class="customEntry"><input type="text" name="customObject" value="" /></div></div></div><div id="currentRelation"><p></p><button>Add Relation</button></div></div>');
var h=$("#tripleDialog");h.dialog({title:"Add Relation",modal:!0,resizable:!0,closeOnEscape:!0,height:450,width:600,autoOpen:!1,buttons:{Close:function(){h.dialog("close")}}});$("#subjectColumn input").watermark("Custom Subject");$("#predicateColumn input").watermark("Custom Predicate");$("#objectColumn input").watermark("Custom Object");$("#tripleColumnsParent input").keyup(function(){$(this).parents(".column").find("li").removeClass("selected");i()});$("#currentRelation button").button({disabled:!0}).click(function(){var b=
f(),i=b[0],c=b[1],b=b[2],e=tinymce.DOM.uniqueId("tri_");a.triples.push({id:e,subject:i,predicate:{text:c.text,name:j(c.text),external:c.external},object:b});a.relations.update()});var j=function(a){for(var a=a.split(/\s/),b="",c=0;c<a.length;c++)b=0==c?b+a[c].toLowerCase():b+a[c].replace(/^./,function(a){return a.toUpperCase()});return b},f=function(){var b=[null,null,null];$("#tripleColumnsParent ul").each(function(f){var c=$(this).find(".selected");1==c.length&&(b[f]={text:a.u.escapeHTMLString(c.text()),
uri:c.attr("name"),external:!1})});$("#tripleColumnsParent input").each(function(f){var c=$(this).val();""!=c&&(b[f]={text:a.u.escapeHTMLString(c),uri:a.u.escapeHTMLString(c),external:!0})});return b},i=function(){for(var a="",b=f(),c=!0,i=0;i<b.length;i++){var e=b[i];null==e?c=!1:(a+=e.text,a=2>i?a+" ":a+".")}$("#currentRelation p").text(a);c?$("#currentRelation button").button("enable"):$("#currentRelation button").button("disable")};return{show:function(){$("#subjectColumn > ul, #predicateColumn > ul, #objectColumn > ul").empty();
$("#currentRelation p").html("");var d="",f;for(f in a.entities)var c=a.entities[f],d=d+('<li class="'+c.props.type+'" name="'+c.props.id+'"><span class="box"/><span class="entityTitle">'+c.props.title+"</span></li>");$("#subjectColumn > ul, #objectColumn > ul").html(d);$("#tripleDialog .entitiesList > li").hover(function(){$(this).hasClass("selected")||$(this).addClass("over")},function(){$(this).hasClass("selected")||$(this).removeClass("over")}).click(function(){$(this).siblings("li").removeClass("selected");
$(this).removeClass("over").toggleClass("selected");$(this).parents(".column").find("input").val("");if(0<$(this).parents("#subjectColumn").length)if($(this).hasClass("selected")){var c=a.entities[$(this).attr("name")].props.type;$("#predicateColumn > ul").empty();for(var c=b[c]||["is associated with"],d="",f=0;f<c.length;f++)d+="<li>"+c[f]+"</li>";$("#predicateColumn > ul").html(d);$("#predicateColumn ul li").click(function(){$(this).siblings("li").removeClass("selected");$(this).toggleClass("selected");
$(this).parents(".column").find("input").val("");i()})}else $("#predicateColumn > ul").empty();i()});h.dialog("open")},hide:function(){h.dialog("close")}}};var DialogManager=function(e){var a=null,b={message:new MessageDialog(e),search:new SearchDialog(e),note:new NoteDialog(e),citation:new CitationDialog(e),correction:new CorrectionDialog(e),keyword:new KeywordDialog(e),title:new TitleDialog(e),date:new DateDialog(e),link:new LinkDialog(e),addperson:new AddPersonDialog(e),addplace:new AddPlaceDialog(e),addevent:new AddEventDialog(e),addorg:new AddOrganizationDialog(e),triple:new TripleDialog(e),header:new HeaderDialog(e)};b.person=b.search;b.place=
b.search;b.event=b.search;b.org=b.search;return{getCurrentType:function(){return a},show:function(e,j){b[e]&&(a=e,b[e].show(j))},confirm:function(e){a="message";b.message.confirm(e)},hideAll:function(){for(var a in b)b[a].hide()}}};var Utilities=function(e){var a=e.writer,e={getTitleFromContent:function(a){return 34>=a.length?a:a.substring(0,34)+"&#8230;"},escapeHTMLString:function(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a},unescapeHTMLString:function(a){return"string"==typeof a?a.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"):a},isSelectionValid:function(b,i){function d(a,
b,c){if(20<c)return null;a="back"==b?a.lastChild||a.previousSibling||a.parentNode.previousSibling:a.firstChild||a.nextSibling||a.parentNode.nextSibling;return null==a?null:a.nodeType==Node.TEXT_NODE?a:d(a,b,c++)}var e=a.editor.selection,c=e.getRng(!0);if("body"==c.commonAncestorContainer.nodeName.toLowerCase()){var h=a.editor.$("body > *")[0];c.setStartBefore(h.firstChild);c.setEndAfter(h.lastChild)}if(!b){if(c.startContainer.nodeType==Node.ELEMENT_NODE){h=c.endContainer;if(h.nodeType!=Node.TEXT_NODE||
0==c.endOffset){h=d(c.endContainer,"back",0);if(null==h)return a.NO_COMMON_PARENT;c.setEnd(h,h.length)}c.setStart(h,0)}c.endContainer.nodeType==Node.ELEMENT_NODE&&c.setEnd(c.startContainer,c.startContainer.length)}if(!i){var j=function(a,b,c){if(0<b&&20>c){a.startOffset<a.startContainer.length&&(a.setStart(a.startContainer,a.startOffset+1),b--);if(a.startOffset==a.startContainer.length){var f=d(a.startContainer,"forward",0);null!=f&&a.setStart(f,0)}j(a,b,c++)}},q=function(a,b,c){if(0<b&&20>c){0<a.endOffset&&
(a.setEnd(a.endContainer,a.endOffset-1),b--);if(0==a.endOffset){var f=d(a.endContainer,"back",0);null!=f&&a.setEnd(f,f.length)}q(a,b,c++)}},h=c.toString(),l=h.match(/^\s+/),g=0,r=0;null!=l&&(g=l[0].length);l=h.match(/\s+$/);null!=l&&(r=l[0].length);j(c,g,0);q(c,r,0);e.setRng(c)}if(c.startContainer.parentNode!=c.endContainer.parentNode)if(0==c.endOffset&&c.endContainer.previousSibling==c.startContainer.parentNode)c.setEnd(c.startContainer,c.startContainer.length);else return a.NO_COMMON_PARENT;if(b||
a.mode==a.XML){l=c.startContainer;for(e={};l!=c.endContainer;)if(l=l.nextSibling,h=$(l),h.hasClass("entity"))if(h.hasClass("start"))e[h.attr("name")]=!0;else if(e[h.attr("name")])delete e[h.attr("name")];else return a.NO_COMMON_PARENT;var c=0,y;for(y in e)c++;if(0!=c)return a.NO_COMMON_PARENT}return a.VALID}},b=function(a,i,d,e,c){a.find(e).each(function(a,b){var f=$(b);if(!(0<f.parents("element").length&&0<d)){var i={name:f.attr("name"),level:d+0};i[e]=f;c.push(i)}});a.find("ref").each(function(a,
f){var h=$(f).attr("name");!(0<$(f).parents("element").length&&0<d)&&!i[h]&&(i[h]=!0,h=$('define[name="'+h+'"]',writer.schemaXML),b(h,i,d+1,e,c))})};e.getChildrenForTag=function(a){var i=$('element[name="'+a.tag+'"]',writer.schemaXML),d=[];b(i,{},0,a.type||"element",d);if("array"==a.returnType)return d.sort(function(a,b){return a.level-b.level}),d;a={};for(i=0;i<d.length;i++){var e=d[i];a[e.name]=e}return a};var h=function(a,b,d,e){$('define:has(ref[name="'+a+'"])',writer.schemaXML).each(function(a,
f){var j=$(f).attr("name");if(!b[j]){b[j]=!0;var q=$(f).find("element").first();1==q.length?e[q.attr("name")]={name:q.attr("name"),level:d+0}:h(j,b,d+1,e)}})};e.getParentsForTag=function(a){var a=$('element[name="'+a+'"]',writer.schemaXML).parents("define").attr("name"),b={};h(a,{},0,b);return b};var j=function(a,b,d,e){if(e.isTrue)return!1;if(0<a.find("text").length)return e.isTrue=!0,!1;a.find("ref").each(function(a,f){var h=$(f).attr("name");if(!(0<$(f).parents("element").length&&0<d)&&!b[h])return b[h]=
!0,h=$('define[name="'+h+'"]',writer.schemaXML),j(h,b,d+1,e)})};e.canTagContainText=function(a){if(a==writer.root)return!1;var a=$('element[name="'+a+'"]',writer.schemaXML),b={isTrue:!1};j(a,{},0,b);return b.isTrue};return e};var FileManager=function(e){function a(a){var c=[],d=a.attr("id"),a=a.attr("_tag")||a.attr("_type"),f=b.structs[d],d=b.entities[d];if(f){var d="<"+a,e;for(e in f)if(0!=e.indexOf("_")){var i=e;"id"==i&&(i=b.idName);d+=" "+i+'="'+f[e]+'"'}c.push(d+">");c.push("</"+a+">")}else c=d?b.em.getMappingTags(d,b.validationSchema):["",""];return c}var b=e.writer,h=null,j=[];$(document.body).append('<div id="loader"><div id="files"><ul class="searchResults"></ul></div></div><div id="saver"><label for="filename">Name</label><input type="text" name="filename"/><p>Please enter letters only.</p></div><div id="unsaved"><p>You have unsaved changes.  Would you like to save?</p></div><div id="entitiesConverter"></div><div id="editSourceDialog"><textarea style="width: 100%; height: 98%;"></textarea></div>');
var f=$("#loader");f.dialog({title:"Load Document",modal:!0,height:450,width:300,autoOpen:!1,buttons:{Load:function(){var a=$("#files ul li.selected").data();a?(c.loadDocument(a.name),f.dialog("close")):$("#files").css({borderColor:"red"})},Cancel:function(){f.dialog("close")}}});var i=$("#saver");i.dialog({title:"Save Document As",modal:!0,resizable:!1,height:150,width:300,autoOpen:!1,buttons:{Save:function(){var a=$("#saver input").val();null!=a.match(/[^A-Za-z]+/)?b.d.show("message",{title:"Invalid Name",
msg:"You may only enter upper or lowercase letters; no numbers, spaces, or punctuation.",type:"error"}):"info"==a?b.d.show("message",{title:"Invalid Name",msg:"This name is reserved, please choose a different one.",type:"error"}):-1!=$.inArray(a,j)?b.d.show("message",{title:"Invalid Name",msg:"This name already exists, please choose a different one.",type:"error"}):(h=a,c.validate(!0),i.dialog("close"))},Cancel:function(){i.dialog("close")}}});var d=$("#unsaved");d.dialog({title:"Unsaved Changes",
modal:!0,resizable:!1,height:150,width:300,autoOpen:!1,buttons:{Save:function(){d.dialog("close");c.saveDocument()},"New Document":function(){window.location="index.htm"}}});var k=$("#editSourceDialog");k.dialog({title:"Edit Source",modal:!0,resizable:!0,closeOnEscape:!0,height:480,width:640,autoOpen:!1,buttons:{Ok:function(){b.d.show("message",{title:"Edit Source",msg:"Edit Source does not currently modify the underlying document.",type:"info"});k.dialog("close")},Cancel:function(){k.dialog("close")}}});
var c={openLoader:function(){$("#files").css({borderColor:"#fff"});n(function(){var a="",b="",d,e;for(e=0;e<j.length;e++)d=j[e],b=e==j.length-1?"last":"",a+='<li class="unselectable '+b+'">',a+="<span>"+d+"</span>",a+="</li>";$("#files ul").first().html(a);$("#files ul li").each(function(a){$(this).data({name:j[a]})});$("#files ul li").click(function(){$("#files").css({borderColor:"#fff"});var a=$(this).hasClass("selected");$("#files ul li").removeClass("selected");a||$(this).addClass("selected")});
$("#files ul li").dblclick(function(){$("#files ul li").removeClass("selected");$(this).addClass("selected");c.loadDocument($(this).data("name"));f.dialog("close")});f.dialog("open")})},openSaver:function(){n();i.dialog("open")}},n=function(a){$.ajax({url:b.baseUrl+"editor/documents",type:"GET",dataType:"json",success:[function(a){j=a},a],error:function(){b.d.show("message",{title:"Error",msg:"Error getting documents.",type:"error"})}})};c.newDocument=function(){b.editor.isDirty()?d.dialog("open"):
window.location="index.htm"};c.validate=function(a){var d=m(!1);$.ajax({url:b.baseUrl+"services/validator/validate.html",type:"POST",dataType:"XML",data:{sch:"http://cwrc.ca/schema/"+b.validationSchema,type:"RNG_XML",content:d},success:function(f){var e=h;null==e&&(e="The current document");a?"pass"!=$("status",f).text()?b.d.confirm({title:"Document Invalid",msg:e+" is not valid. <b>Save anyways?</b>",callback:function(a){a&&c.saveDocument()}}):c.saveDocument():b.validation.showValidationResult(f,
d)},error:function(){b.d.show("message",{title:"Error",msg:"An error occurred while trying to validate "+h+".",type:"error"})}})};c.saveDocument=function(){if(null==h)c.openSaver();else{var a=m(!0);$.ajax({url:b.baseUrl+"editor/documents/"+h,type:"PUT",dataType:"json",data:a,success:function(){b.editor.isNotDirty=1;b.d.show("message",{title:"Document Saved",msg:h+" was saved successfully."})},error:function(){b.d.show("message",{title:"Error",msg:"An error occurred and "+h+" was not saved.",type:"error"})}})}};
c.buildXMLString=function(b){function c(b){var f=a(b);d+=f[0];b.contents().each(function(a,b){1==b.nodeType?c($(b)):3==b.nodeType&&(d+=b.data)});d+=f[1]}var d="";c(b);return d};var m=function(d){b.highlightEntity();var f='<?xml version="1.0" encoding="UTF-8"?>\n',e=$(b.editor.getBody()),i=e.clone(!1,!0);q(e);var g="";if(d){var g='\n<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:w="http://cwrctc.artsrn.ualberta.ca/#">'+('\n<rdf:Description rdf:about="'+(b.baseUrl+"editor/documents/"+
h)+'">\n\t<w:mode>'+b.mode+"</w:mode>\n</rdf:Description>"),j=function(a){a.contents().each(function(){var a=$(this);if(this.nodeType==Node.TEXT_NODE&&" "!=this.data)k+=this.length;else if(a.is(b.root)||a.attr("_tag")){var c=a.attr("id");m.push({id:c,offset:k,length:a.text().length});j(a)}else a.attr("_entity")&&a.hasClass("start")&&(c=a.attr("name"),m.push({id:c,offset:k,length:b.entities[c].props.content.length,entity:!0}))})},k=0,m=[];j(e);for(var d=m,l={},t=[],u=0;u<d.length;u++){var v=d[u];v.entity&&
(t.push(v),l[v.id]={contains:[],overlaps:[]})}v=t.length;for(u=0;u<v;u++)for(var n=t[u],A=n.offset+n.length,C=l[n.id],D=0;D<v;D++){var x=t[D],B=x.offset+x.length;n.offset<x.offset&&A>B?C.contains.push(x.id):n.offset<x.offset&&A>x.offset&&A<B?C.overlaps.push(x.id):n.offset>x.offset&&A>B&&B>n.offset?C.overlaps.push(x.id):n.offset<x.offset&&(A<B&&A>x.offset)&&C.overlaps.push(x.id)}for(t=0;t<d.length;t++){var u=d[t],g=g+('\n<rdf:Description rdf:ID="'+u.id+'">'),s;for(s in u)g+="\n\t<w:"+s+' type="offset">'+
u[s]+"</w:"+s+">";if(u.entity){v=b.entities[u.id];g+='\n\t<w:type type="props">'+v.props.type+"</w:type>";g+='\n\t<w:content type="props">'+v.props.content+"</w:content>";for(s in v.info)g+="\n\t<w:"+s+' type="info">'+v.info[s]+"</w:"+s+">";u=l[u.id];for(v=0;v<u.contains.length;v++)g+="\n\t<w:contains>"+u.contains[v]+"</w:contains>";for(v=0;v<u.overlaps.length;v++)g+="\n\t<w:overlaps>"+u.overlaps[v]+"</w:overlaps>"}g+="\n</rdf:Description>"}for(t=0;t<b.triples.length;t++)s=b.triples[t],g+='\n<rdf:Description rdf:about="'+
s.subject.uri+'" w:external="'+s.subject.external+'">\n\t<w:'+s.predicate.name+' w:text="'+s.predicate.text+'" w:external="'+s.predicate.external+'">\n\t\t<rdf:Description rdf:about="'+s.object.uri+'" w:external="'+s.object.external+'" />\n\t</w:'+s.predicate.name+">\n</rdf:Description>";g+="\n</rdf:RDF>\n"}for(var z in b.entities){s=b.editor.dom.select('[name="'+z+'"]');t=s[0];d=s[1];for(l=[t];t!=d&&null!=t;)t=t.nextSibling,l.push(t);b.editor.$(l).wrapAll('<entity id="'+z+'" _type="'+b.entities[z].props.type+
'" />');b.editor.$(s).remove()}z=e.children(b.root);"TEI"==b.root&&z.attr("xmlns","http://www.tei-c.org/ns/1.0");s=a(z);f+=s[0];f+=g;z.contents().each(function(a,b){1==b.nodeType?f+=c.buildXMLString($(b)):3==b.nodeType&&(f+=b.data)});f+=s[1];e.replaceWith(i);return f},q=function(a){$(a).contents().each(function(a,b){b.nodeType==Node.TEXT_NODE?b.nodeValue.match(/&.+?;/gim)&&($("#entitiesConverter")[0].innerHTML=b.nodeValue,b.nodeValue=$("#entitiesConverter")[0].innerText||$("#entitiesConverter")[0].firstChild.nodeValue):
b.nodeType==Node.ELEMENT_NODE&&q(b)})};c.loadDocumentFromUrl=function(a){h=a;b.entities={};b.structs={};b.triples=[];$.ajax({url:a,type:"GET",success:l,error:function(c,d){h=null;b.d.show("message",{title:"Error",msg:"An error ("+d+") occurred and "+a+" was not loaded.",type:"error"})},dataType:"xml"})};c.loadDocument=function(a){h=a;b.entities={};b.structs={};b.triples=[];$.ajax({url:b.baseUrl+"editor/documents/"+a,type:"GET",success:l,error:function(c,d){h=null;b.d.show("message",{title:"Error",
msg:"An error ("+d+") occurred and "+a+" was not loaded.",type:"error"})},dataType:"xml"})};c.buildEditorString=function(a){function c(a){var f=a.nodeName;d=f==b.root?d+("<"+f.toLowerCase()):d+"<span";d+=' _tag="'+f+'"';var e=$(a).attr(b.idName);null==e&&(e=tinymce.DOM.uniqueId("struct_"),d+=' id="'+e+'"');var g=parseInt(e.split("_")[1]);g>tinymce.DOM.counter&&(tinymce.DOM.counter=g);g=b.u.canTagContainText(f);d+=' _textallowed="'+g+'"';b.structs[e]={id:e,_tag:f,_textallowed:g};$(a.attributes).each(function(a,
c){var f=c.name;f==b.idName&&(f="id");b.structs[e][f]=c.value;if("id"==f||null!=f.match(/^_/))d+=" "+f+'="'+c.value+'"'});d+=">";$(a).contents().each(function(a,b){1==b.nodeType?c(b):3==b.nodeType&&(d+=b.data)});d=f==b.root?d+("</"+f.toLowerCase()+">"):d+"</span>"}var d="";c(a);return d};var l=function(a){function d(){var f=[],e=$(a).find("rdf\\:RDF, RDF"),g;g=parseInt(e.find("w\\:mode, mode").first().text())==b.XML?b.XML:b.XMLRDF;b.mode!=g&&(b.d.show("message",{title:"Editor Mode changed",msg:"The Editor Mode ("+
(b.mode==b.XML?"XML only":"XML & RDF")+") has been changed to match the Document Mode ("+(g==b.XML?"XML only":"XML & RDF")+").",type:"info"}),b.mode=g);if(g==b.XMLRDF)e.children().each(function(){var a=$(this);if(a.attr("rdf:ID")){var c=a.find("w\\:id, id").text();if(""!=a.find("w\\:entity, entity").text()){var d=parseInt(c.split("_")[1]);d>tinymce.DOM.counter&&(tinymce.DOM.counter=d);f.push({id:c,parent:a.find("w\\:parent, parent").text(),offset:parseInt(a.find("w\\:offset, offset").text()),length:parseInt(a.find("w\\:length, length").text())});
b.entities[c]={props:{id:c},info:{}};a.children('[type="props"]').each(function(){var a=$(this)[0].nodeName.split(":")[1].toLowerCase(),d=$(this).text();if("content"==a){var f=b.u.getTitleFromContent(d);b.entities[c].props.title=f}b.entities[c].props[a]=d});a.children('[type="info"]').each(function(){var a=$(this)[0].nodeName.split(":")[1].toLowerCase();b.entities[c].info[a]=$(this).text()})}}else if(a.attr("rdf:about")){var d=$(this),e=d.attr("rdf:about"),g=a.children().first(),a=a.find("rdf\\:Description, Description"),
i=a.attr("rdf:about"),d={subject:{uri:e,text:"false"==d.attr("w:external")?b.entities[e].props.title:e,external:d.attr("w:external, external")},predicate:{text:g.attr("w:text"),name:g[0].nodeName.split(":")[1].toLowerCase(),external:g.attr("w:external")},object:{uri:i,text:"false"==a.attr("w:external")?b.entities[i].props.title:i,external:a.attr("w:external")}};b.triples.push(d)}}),$(a).find("rdf\\:RDF, RDF").remove();else{var i=function(a,c){var d=0;a.contents().each(function(){if(this.nodeType==
Node.TEXT_NODE)d+=this.length;else if(b.em.isEntity(this.nodeName.toLowerCase())){var f=$(this),e=f.attr(b.idName);null==e&&(e=tinymce.DOM.uniqueId("ent_"));c.push({id:e,parent:$(a).attr(b.idName),offset:d,length:f.text().length});var g=f.text();b.entities[e]={props:{id:e,type:this.nodeName.toLowerCase(),content:g,title:b.u.getTitleFromContent(g)},info:{}};$(this.attributes).each(function(a,c){b.entities[e].info[c.name]=c.value});f.contents().unwrap()}else i($(this),c)})};i($(a.firstChild),f)}e=a.getElementsByTagName(b.root)[0];
e=c.buildEditorString(e);b.editor.setContent(e);b.editor.focus();var h,j,k,m,l,n,p,q;for(g=0;g<f.length;g++){q=p=null;n=l=0;h=f[g];e=h.id;if(""!=h.parent)j=b.editor.$("#"+h.parent),j=j.contents().filter(function(){return this.nodeType==Node.TEXT_NODE}),l=h.offset,k=0,m=!1,p=j.filter(function(){if(!m){k+=this.length;if(k>h.offset)return m=!0;l-=this.length}return!1})[0],n=h.offset+h.length,k=0,m=!1,q=j.filter(function(){if(!m){k+=this.length;if(k>=h.offset+h.length)return m=!0;n-=this.length}return!1})[0];
else{j=$(b.editor.getDoc().body);var y=0,x=function(a){a.contents().each(function(){this.nodeType==Node.TEXT_NODE&&" "!=this.data?(y+=this.length,y>h.offset&&null==p&&(p=this,l=h.offset-(y-this.length)),y>=h.offset+h.length&&null==q&&(q=this,n=l+h.length)):x($(this));if(null!=p&&null!=q)return!1})};x(j)}if(null!=p&&null!=q){j=b.editor.selection.getRng(!0);try{j.setStart(p,l),j.setEnd(q,n),b.insertBoundaryTags(e,b.entities[e].props.type,j)}catch(B){}}}b.entitiesList.update();b.tree.update(!0);b.relations.update()}
var f;0<a.getElementsByTagName("EVENTS").length?(f="events",b.idName="ID"):(f="tei",b.idName="xml:id");f!=b.root.toLowerCase()?"events"==f?c.loadSchema("events",!1,d):c.loadSchema("cwrcbasic",!1,d):d()};c.editSource=function(){var a=m(!0);$("textarea",k).val(a);k.dialog("open")};c.xmlToString=function(a){var b="";try{b=window.ActiveXObject?a.xml:(new XMLSerializer).serializeToString(a)}catch(c){alert(c)}return b};c.loadSchema=function(a,d,f){var e="",g=null==b.project?"":b.baseUrl,i,h=b.editor.schema.getBlockElements();
"events"==a?(e=g+"schema/events.rng",i="css/orlando_converted.css",h.L={},h.P={},b.root="EVENTS",b.header="ORLANDOHEADER",b.idName="ID"):(e=g+"schema/CWRC-TEIBasic.rng",i="css/tei_converted.css",h.l={},h.p={},h.sp={},b.root="TEI",b.header="teiHeader",b.idName="xml:id");b.validationSchema=a;b.editor.settings.forced_root_block=b.root;b.editor.schema.addCustomElements(b.root);b.editor.schema.addCustomElements(b.root.toLowerCase());$.ajax({url:e,success:function(a){function e(){$("#schemaTags",b.editor.dom.doc).remove();
$("#schemaRules",b.editor.dom.doc).remove();c.loadSchemaCSS(i);$("head",b.editor.dom.doc).append('<style id="schemaTags" type="text/css" />');var a=b.root,g=b.root.toLowerCase()+" { display: block; }",g=g+(".showStructBrackets "+b.root.toLowerCase()+':before { color: #aaa; font-weight: normal; font-style: normal; font-family: monospace; content: "<'+a+'>"; }'),g=g+(".showStructBrackets "+b.root.toLowerCase()+':after { color: #aaa; font-weight: normal; font-style: normal; font-family: monospace; content: "</'+
a+'>"; }'),h=[];$("element",b.schemaXML).each(function(a,b){var c=$(b).attr("name");-1==h.indexOf(c)&&(h.push(c),g+=".showStructBrackets span[_tag="+c+']:before { color: #aaa; font-weight: normal; font-style: normal; font-family: monospace; content: "<'+c+'>"; }',g+=".showStructBrackets span[_tag="+c+']:after { color: #aaa; font-weight: normal; font-style: normal; font-family: monospace; content: "</'+c+'>"; }')});g+="span[_tag="+b.header+"] { display: none !important; }";$("#schemaTags",b.editor.dom.doc).text(g);
b.schema.elements=h;a="";d&&(a="Paste or type your text here.");b.editor.setContent("<"+b.root+' _tag="'+b.root+'">'+a+"</"+b.root+">");b.entitiesList.update();b.tree.update(!0);b.relations.update();f&&f()}b.schemaXML=a;var h=$("include:first",b.schemaXML);1==h.length?(a=h.attr("href"),$.ajax({url:g+"schema/"+a,success:function(a){h.children().each(function(b,c){if("start"==c.nodeName)$("start",a).replaceWith(c);else if("define"==c.nodeName){var d=$(c).attr("name"),d=$('define[name="'+d+'"]',a);1==
d.length?d.replaceWith(c):$("grammar",a).append(c)}});h.replaceWith($("grammar",a).children());e()}})):e()},error:function(a,c,d){b.d.show("message",{title:"Error",msg:"Error loading schema: "+d,type:"error"})}})};c.loadSchemaCSS=function(a){function c(){for(var a=null,f=b.editor.getDoc().styleSheets,e=0;e<f.length;e++){var g=f[e];if(g.href&&-1!=g.href.indexOf(d)){a=g;break}}if(a)try{$("#schemaRules",b.editor.dom.doc).remove();for(var i=a.cssRules,f="",e=0;e<i.length;e++)var h=i[e].selectorText,j=
h.replace(/(^|,|\s)(\w+)/g,function(a,b,c){return b+'span[_tag="'+c+'"]'}),k=i[e].cssText.replace(h,j),f=f+(k+"\n");$("head",b.editor.dom.doc).append('<style id="schemaRules" type="text/css" />');$("#schemaRules",b.editor.dom.doc).text(f);a.disabled=!0}catch(m){setTimeout(c,25)}else setTimeout(c,25)}b.editor.dom.loadCSS(a);if(null==a.match("converted")){var d=a.split("/"),d=d[d.length-1],f=b.editor.getDoc().styleSheets.length,e=null;0<f?c():e=setInterval(function(){b.editor.getDoc().styleSheets.length>
f&&(clearInterval(e),c())},25)}};c.loadInitialDocument=function(a){a.match("load")?c.openLoader():a.match("sample_letter")?g("xml/sample_letter.xml"):a.match("sample_poem")?g("xml/sample_poem.xml"):a.match("event")?g("xml/event_template.xml"):a.match("letter")?g("xml/letter_template.xml"):a.match("poem")?g("xml/poem_template.xml"):a.match("prose")?g("xml/prose_template.xml"):c.loadSchema("cwrcbasic",!0)};var g=function(a){$.ajax({url:a,dataType:"xml",success:function(a){var b=a.createElement("rdf:RDF");
$(a.childNodes?a.childNodes[a.childNodes.length-1]:a.firstChild).prepend(b);l(a)}})};return c};$.fn.filterNode=function(e){return this.find("*").filter(function(){return this.nodeName===e})};var StructureTree=function(e){var a=e.writer,b={},h=!1;$(e.parentId).append('<div id="structure"><div id="tree"></div></div>');$(document.body).append('<div id="tree_popup"></div>');$("#tree").jstree({core:{},themeroller:{},ui:{select_limit:1},json_data:{data:{data:"Tags",attr:{id:"root"},state:"open"}},contextmenu:{select_node:!0,show_at_node:!1,items:function(b){function e(b){var c={},d=!1,f;for(f in b){var d=!0,i=$("a\\:documentation, documentation",b[f].element).first(),i=1==i.length?i.text():
f;c[f]={label:'<span title="'+i+'">'+f+"</span>",icon:"img/tag_blue.png",action:function(b){var c=b.parents("li.submenu").children("a").attr("rel"),b=b.text(),d={x:parseInt($("#tree_popup").css("left")),y:parseInt($("#tree_popup").css("top"))};"change"==c?(c=$("#tree a.ui-state-active").closest("li").attr("name"),a.editor.execCommand("changeTag",{key:b,pos:d,id:c})):(a.editor.currentBookmark=a.editor.selection.getBookmark(1),a.editor.execCommand("addSchemaTag",{key:b,pos:d,action:c}))}}}d||(c.no_tags=
{label:"No tags available.",icon:"img/cross.png",action:function(){}});return c}$("#tree_popup").hide();if("root"==b.attr("id"))return{};var d=b.parents("li:first"),b=a.structs[b.attr("name")];if(b._tag==a.root||b._tag==a.header)return{};var h=a.structs[d.attr("name")],c=a.editor.execCommand("getChildrenForTag",{tag:b._tag,type:"element",returnType:"object"}),j=a.editor.execCommand("getParentsForTag",b._tag),d={};h&&(d=a.editor.execCommand("getChildrenForTag",{tag:h._tag,type:"element",returnType:"object"}));
h=e(c);j=e(j);d=e(d);d={before:{label:"Insert Tag Before",icon:"img/tag_blue_add.png",_class:"submenu",submenu:d},after:{label:"Insert Tag After",icon:"img/tag_blue_add.png",_class:"submenu",submenu:d},around:{label:"Insert Tag Around",icon:"img/tag_blue_add.png",_class:"submenu",submenu:j},inside:{label:"Insert Tag Inside",icon:"img/tag_blue_add.png",_class:"submenu",separator_after:!0,submenu:h},change:{label:"Change Tag",icon:"img/tag_blue_edit.png",_class:"submenu",submenu:d},edit:{label:"Edit Tag",
icon:"img/tag_blue_edit.png",action:function(b){var c={x:parseInt($("#tree_popup").css("left")),y:parseInt($("#tree_popup").css("top"))};a.editor.execCommand("editTag",b.attr("name"),c)}},"delete":{label:"Remove Tag Only",icon:"img/tag_blue_delete.png",action:function(b){a.removeStructureTag(b.attr("name"))}},delete_all:{label:"Remove Tag and All Content",icon:"img/tag_blue_delete.png",action:function(b){a.removeStructureTag(b.attr("name"),!0)}}};b._tag==a.root&&(delete d["delete"],delete d.before,
delete d.after,delete d.around);return d}},hotkeys:{del:function(){if(this.is_selected()){var b=this.get_selected().attr("name");b&&a.removeStructureTag(b)}},f2:!1},plugins:["json_data","ui","themeroller","contextmenu","hotkeys"]});$("#tree").mousemove(function(a){$("#tree_popup").offset({left:a.pageX+15,top:a.pageY+5})});$("#tree").bind("select_node.jstree",function(b,e){if(!h){var d=e.rslt.obj.attr("name");d&&(a.structs[d]._tag==a.header?a.d.show("header"):a.selectStructureTag(d))}h=!1});$("#tree").bind("hover_node.jstree",
function(b,e){if("visible"!=$("#vakata-contextmenu").css("visibility")){var d=e.rslt.obj;if("root"!=d.attr("id")){var d=d.attr("name"),d=a.structs[d],h="<ul>",c;for(c in d)0!=c.indexOf("_")&&(h+="<li>"+c+": "+d[c]+"</li>");c=h+"</ul>";$("#tree_popup").html(c).show()}}});$("#tree").bind("dehover_node.jstree",function(){$("#tree_popup").hide()});b.update=function(){var b=a.editor.dom.select("body");$("#tree").jstree("delete_node","#root");var e=$("#tree").jstree("create_node",$("#tree"),"first",{data:"Tags",
attr:{id:"root"},state:"open"});j($(b).children(),e)};var j=function(b,e){b.each(function(){var b=$(this).children(),f=e;if($(this).attr("_tag")||$(this).is(a.root)){var c=$(this).attr("id"),h=0<$(this).find("[_tag]").length?"open":null;$(this).attr("_tag")==a.header&&(h=!1);if(""==c||null==c){var c=tinymce.DOM.uniqueId("struct_"),m=$(this).attr("_tag");null==m&&$(this).is(a.root)&&(m=a.root);-1!=a.schema.elements.indexOf(m)&&($(this).attr("id",c).attr("_tag",m),a.structs[c]={id:c,_tag:m})}else null==
a.structs[c]?(m=a.deletedStructs[c],null!=m&&(a.structs[c]=m,delete a.deletedStructs[c])):(m=a.editor.$("[id="+c+"]"),1<m.length&&m.each(function(b,d){if(0<b){var e=$(d),f=tinymce.DOM.uniqueId("struct_");e.attr("id",f);a.structs[f]={};for(var h in a.structs[c])a.structs[f][h]=a.structs[c][h];a.structs[f].id=f}}));if(m=a.structs[c])f=m._tag,f=$("#tree").jstree("create_node",e,"last",{data:f,attr:{name:c,"class":$(this).attr("class")},state:h})}$(this).attr("_tag")!=a.header&&j(b,f)})};b.selectNode=
function(a){a&&(h=!0,"tree"==$("#tree").jstree("select_node",$('#tree [name="'+a+'"]'),!0).attr("id")&&(h=!1))};return b};var EntitiesList=function(e){var a=e.writer,b=["_id","_ref"],h=!1,j={};$(e.parentId).append('<div id="entities"><ul class="entitiesList ui-layout-center"></ul><div id="entitiesOptions" class="ui-layout-south"><div id="sortBy"><span>Sort By</span> <input type="radio" id="sequence" name="sortBy" checked="checked" /><label for="sequence">Sequence</label><input type="radio" id="category" name="sortBy" /><label for="category">Category</label></div><div><input type="checkbox" id="metaKeys" /><label for="metaKeys">Show Metadata</label></div></div></div>');
$(document.body).append('<div id="entitiesMenu" class="contextMenu" style="display: none;"><ul><li id="editEntity"><ins style="background:url(img/tag_blue_edit.png) center center no-repeat;" />Edit Entity</li><li id="removeEntity"><ins style="background:url(img/cross.png) center center no-repeat;" />Remove Entity</li><li class="separator" id="copyEntity"><ins style="background:url(img/tag_blue_copy.png) center center no-repeat;" />Copy Entity</li></ul></div>');$("#sequence").button().click(function(){a.entitiesList.update("sequence");
a.highlightEntity(a.editor.currentEntity)});$("#category").button().click(function(){a.entitiesList.update("category");a.highlightEntity(a.editor.currentEntity)});$("#sortBy").buttonset();$("#metaKeys").button().click(function(){h=!h;a.entitiesList.update();a.highlightEntity(a.editor.currentEntity)});j.layout=$("#entities").layout({defaults:{resizable:!1,slidable:!1,closable:!1},south:{size:"auto",spacing_open:0}});j.update=function(b){null==b&&(b=$("#sequence").prop("checked")?"sequence":"category");
$("#entities > ul").empty();var d,e,c="",h=a.editor.$("span[class~=start]");if("category"==b){var j={};h.each(function(b,c){d=$(c).attr("name");if(null==a.entities[d]){var f=a.deletedEntities[d];if(null!=f)e=a.entities[d]=f,delete a.deletedEntities[d];else{a.removeEntity(d);return}}else e=a.entities[d];null==j[e.props.type]&&(j[e.props.type]=[]);j[e.props.type].push(e)});var q;for(d in j){q=j[d];for(b=0;b<q.length;b++)e=q[b],c+=f(e)}}else"sequence"==b&&h.each(function(){d=$(this).attr("name");if(null==
a.entities[d]){var b=a.deletedEntities[d];if(null!=b)e=a.entities[d]=b,delete a.deletedEntities[d];else{a.removeEntity(d);return}}else e=a.entities[d];e&&(h=h.not("[name="+d+"]"),c+=f(e))});$("#entities > ul").html(c);$("#entities > ul > li").hover(function(){$(this).hasClass("selected")||$(this).addClass("over")},function(){$(this).hasClass("selected")||$(this).removeClass("over")}).mousedown(function(){$(this).removeClass("over");a.highlightEntity(this.getAttribute("name"),null,!0)}).contextMenu("entitiesMenu",
{bindings:{editEntity:function(b){a.editTag($(b).attr("name"))},removeEntity:function(b){a.removeEntity($(b).attr("name"))},copyEntity:function(b){a.copyEntity($(b).attr("name"))}},shadow:!1,menuStyle:{backgroundColor:"#FFFFFF",border:"1px solid #D4D0C8",boxShadow:"1px 1px 2px #CCCCCC",padding:"0px"},itemStyle:{fontFamily:"Tahoma,Verdana,Arial,Helvetica",fontSize:"11px",color:"#000",lineHeight:"20px",padding:"0px",cursor:"pointer",textDecoration:"none",border:"none"},itemHoverStyle:{color:"#000",
backgroundColor:"#DBECF3",border:"none"}})};var f=function(a){var d="<ul>",e=function(a){for(var f in a)if(h||-1==b.indexOf(f)){var i=a[f];$.isPlainObject(i)?e(i):d+="<li><strong>"+f+"</strong>: "+i+"</li>"}};e(a.info);d+="</ul>";return'<li class="'+a.props.type+'" name="'+a.props.id+'"><span class="box"/><span class="entityTitle">'+a.props.title+'</span><div class="info">'+d+"</div></li>"};j.remove=function(a){$('#entities li[name="'+a+'"]').remove()};return j};var EntitiesModel=function(){function e(a,e){var j=$.tmpl(e,a);return j[0]?j[0].outerHTML:""}var a={person:{title:"Person",mapping:{cwrcbasic:'<person cert="${info.certainty}">[[[editorText]]]</person>',events:"<NAME>[[[editorText]]]</NAME>"}},date:{title:"Date",mapping:{cwrcbasic:'<date {{if info.date}}when="${info.date}"{{else info.startDate}}from="${info.startDate}" to="${info.endDate}"{{/if}}>[[[editorText]]]</date>',events:'{{if info.date}}<DATE VALUE="${info.date}">[[[editorText]]]</DATE>{{else info.startDate}}<DATERANGE FROM="${info.startDate}" TO="${info.endDate}">[[[editorText]]]</DATERANGE>{{/if}}'}},
place:{title:"Place",mapping:{cwrcbasic:'<place cert="${info.certainty}">[[[editorText]]]</place>',events:"<PLACE>[[[editorText]]]</PLACE>"}},event:{title:"Event",mapping:{cwrcbasic:'<event cert="${info.certainty}">[[[editorText]]]</event>'}},org:{title:"Organization",mapping:{cwrcbasic:'<org cert="${info.certainty}">[[[editorText]]]</org>',events:"<ORGNAME>[[[editorText]]]</ORGNAME>"}},citation:{title:"Citation",mapping:{cwrcbasic:"<cit><quote>[[[editorText]]]</quote><ref>${info.citation}</ref></cit>"}},
note:{title:"Note",mapping:{cwrcbasic:'<note type="${info.type}" ana="${info.content}">[[[editorText]]]</note>'}},correction:{title:"Correction",mapping:{cwrcbasic:'<sic><corr cert="${info.certainty}" type="${info.type}" ana="${info.content}">[[[editorText]]]</corr></sic>',events:'<SIC CORR="${info.content}">[[[editorText]]]</SIC>'}},keyword:{title:"Keyword",mapping:{cwrcbasic:'<keywords scheme="http://classificationweb.net"><term {{if info.id}}sameAs="${info.id}"{{else info.keyword}}sameAs="${info.keyword}"{{/if}} type="${info.type}">[[[editorText]]]</term></keywords>',
events:"<KEYWORDCLASS>[[[editorText]]]</KEYWORDCLASS>"}},link:{title:"Link",mapping:{cwrcbasic:'<ref target="${info.url}">[[[editorText]]]</ref>',events:'<XREF URL="${info.url}">[[[editorText]]]</XREF>'}},title:{title:"Text/Title",mapping:{cwrcbasic:'<title level="${info.level}">[[[editorText]]]</title>',events:'<TITLE TITLETYPE="${info.level}">[[[editorText]]]</TITLE>'}}};return{isEntity:function(b){return null==a[b]},getTitle:function(b){return(b=a[b])?b.title:null},getMapping:function(b,h){var j=
a[b.props.type];return j&&j.mapping&&j.mapping[h]?e(b,j.mapping[h]):null},getMappingTags:function(b,h){var j=a[b.props.type];return j&&j.mapping&&j.mapping[h]?e(b,j.mapping[h]).split("[[[editorText]]]"):["",""]}}};var Relations=function(e){var a=e.writer;$(e.parentId).append('<div id="relations"><ul class="relationsList"></ul></div>');$(document.body).append('<div id="relationsMenu" class="contextMenu" style="display: none;"><ul><li id="removeRelation"><ins style="background:url(img/cross.png) center center no-repeat;" />Remove Relation</li></ul></div>');var b={update:function(){$("#relations ul").empty();for(var e="",j=0;j<a.triples.length;j++)var f=a.triples[j],e=e+("<li>"+f.subject.text+" "+f.predicate.text+
" "+f.object.text+"</li>");$("#relations ul").html(e);$("#relations ul li").each(function(a){$(this).data("index",a)}).contextMenu("relationsMenu",{bindings:{removeRelation:function(e){e=$(e).data("index");a.triples.splice(e,1);b.update()}},shadow:!1,menuStyle:{backgroundColor:"#FFFFFF",border:"1px solid #D4D0C8",boxShadow:"1px 1px 2px #CCCCCC",padding:"0px",width:"105px"},itemStyle:{fontFamily:"Tahoma,Verdana,Arial,Helvetica",fontSize:"11px",color:"#000",lineHeight:"20px",padding:"0px",cursor:"pointer",
textDecoration:"none",border:"none"},itemHoverStyle:{color:"#000",backgroundColor:"#DBECF3",border:"none"}})}};return b};var Validation=function(e){var a=e.writer;$(e.parentId).append('<div id="validation"><button>Validate</button><button>Clear</button><ul class="validationList"></ul></div>');$("#validation button:eq(0)").button().click(function(){a.fm.validate()});$("#validation button:eq(1)").button().click(function(){$("#validation > ul").empty()});return{showValidationResult:function(b,e){var j=$("#validation > ul");j.empty();e=e.split("\n")[1];"pass"==$("status",b).text()&&j.append('<li class="ui-state-default"><span class="ui-icon ui-icon-check" style="float: left; margin-right: 4px;"></span>Your document is valid!</li>');
$("error, warning",b).each(function(a,b){var d=b.nodeName,k="",c=$(this).find("message").text(),n=parseInt($(this).find("column").text());if(!isNaN(n)){var n=e.substring(0,n).match(/<.*?>/g),m=n[n.length-1],k=m.match(/id="(.*?)"/i);if(null==k)if(-1!=c.search("text not allowed here"))for(var q=0,l=n.length-1;-1<l;l--){if(m=n[l],-1!=m.search("/")?q++:q--,-1==q){k=m.match(/id="(.*?)"/i)[1];break}}else{q=m.match(/<\/(.*)>/)[1];for(l=n.length-1;-1<l;l--){var m=n[l],g=m.match(/<(.*?)\s/);if(null!=g&&g[1]==
q){k=m.match(/id="(.*?)"/i)[1];break}}}else k=k[1]}j.append('<li class="'+("error"==d?"ui-state-error":"ui-state-highlight")+'"><span class="ui-icon '+("error"==d?"ui-icon-alert":"ui-icon-info")+'" style="float: left; margin-right: 4px;"></span>'+c+"</li>").find("li:last").data("id",k)});j.find("li").click(function(){var b=$(this).data("id");b&&a.selectStructureTag(b)});a.layout.center.children.layout1.open("south")}}};